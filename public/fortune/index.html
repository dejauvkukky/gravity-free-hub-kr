<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Garden - ì˜¤ëŠ˜ì˜ ìš´ì„¸ & ë°”ì´ì˜¤ë¦¬ë“¬</title>
    <link rel="stylesheet" href="../../assets/css/style.css?v=6">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .fortune-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .fortune-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .zodiac-badge {
            background: var(--color-lemon);
            color: #d97706;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: #fff;
            color: #666;
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .bio-legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .fortune-cookie-text {
            font-style: italic;
            text-align: center;
            color: #555;
            font-size: 1.1rem;
            line-height: 1.6;
            padding: 10px;
            border-left: 3px solid var(--color-secondary);
            background: #fdfdfd;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <a href="../dashboard.html" class="logo">â† Secret Garden</a>
            <span>ìš´ì„¸ & ë°”ì´ì˜¤ë¦¬ë“¬</span>
        </header>

        <div id="loading" class="p-4 text-center">ë°ì´í„° ë¡œë”©ì¤‘...</div>

        <!-- Main Content (Hidden until loaded) -->
        <div id="content" class="p-4 hidden">

            <div class="text-center" style="margin-bottom: 20px;">
                <h2 style="font-size: 1.3rem; color: var(--color-primary); margin-bottom: 5px;">
                    <span id="header-date"></span>ì˜ ìš´ì„¸
                </h2>
                <p style="color: #666; font-size: 0.9rem;">ìš°ë¦¬ ê°€ì¡±ì˜ ì˜¤ëŠ˜ ì»¨ë””ì…˜ì€?</p>
            </div>

            <!-- TAB Navigation -->
            <div class="tab-container" id="tab-nav">
                <button class="tab-btn active" onclick="switchTab('total')">ğŸ“Š ê°€ì¡± ì¢…í•©</button>
                <!-- Member tabs will be added dynamically -->
            </div>

            <!-- 1. Total View Section -->
            <div id="section-total">
                <div class="fortune-card">
                    <h3 class="card-title">ğŸ“ˆ ê°€ì¡± ì»¨ë””ì…˜ ë­í‚¹</h3>
                    <p style="font-size:0.8rem; color:#888; margin-bottom:15px;">ì˜¤ëŠ˜ì˜ ì‹ ì²´/ê°ì„±/ì§€ì„± í‰ê·  ì ìˆ˜ì…ë‹ˆë‹¤.</p>
                    <div style="height: 250px;">
                        <canvas id="totalChart"></canvas>
                    </div>
                    <div class="text-center mt-3" id="total-comment" style="font-size:0.9rem; color:#333;">
                        ë¶„ì„ ì¤‘...
                    </div>
                </div>
            </div>

            <!-- 2. Individual View Section -->
            <div id="section-individual" class="hidden">
                <!-- Data for specific user -->
                <div class="fortune-card">
                    <div class="fortune-header">
                        <span class="card-title" style="margin:0;" id="ind-name-title">ë©¤ë²„ ì´ë¦„</span>
                        <span id="zodiac-text" class="zodiac-badge">ë³„ìë¦¬ / ë </span>
                    </div>

                    <!-- Text Fortune -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="font-size: 0.95rem; margin-bottom: 8px; color: var(--color-secondary);">ğŸŒŸ ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ
                        </h4>
                        <p id="daily-keyword" style="font-size: 0.9rem; color: #555; margin-bottom: 0;">ë¡œë”© ì¤‘...</p>
                    </div>

                    <h3 class="card-title">ğŸ§¬ ë°”ì´ì˜¤ë¦¬ë“¬ ìƒì„¸</h3>
                    <div style="height: 200px; position: relative;">
                        <canvas id="indChart"></canvas>
                    </div>
                    <div class="bio-legend">
                        <div class="legend-item"><span class="dot" style="background:#22c55e"></span>ì‹ ì²´</div>
                        <div class="legend-item"><span class="dot" style="background:#ef4444"></span>ê°ì„±</div>
                        <div class="legend-item"><span class="dot" style="background:#3b82f6"></span>ì§€ì„±</div>
                    </div>
                </div>
            </div>

            <!-- Common: Fortune Cookie -->
            <div class="fortune-card" style="background: linear-gradient(135deg, #fff, #fdfbf7);">
                <h3 class="card-title" style="text-align: center;">ğŸ¥  ì˜¤ëŠ˜ì˜ í¬ì¶˜ ì¿ í‚¤</h3>
                <div class="fortune-cookie-text" id="fortune-cookie-msg">
                    "í–‰ë³µì€ ì´ë¯¸ ë‹¹ì‹  ê³ì— ìˆìŠµë‹ˆë‹¤."
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { auth, db } from '../../src/firebase.js?v=6';
        import { getZodiac, getChineseZodiac, familyData } from '../../src/users.js?v=6';

        // Local Random Fortune Data
        const fortuneCookies = [
            "ì‘ì€ í–‰ë³µì„ ì†Œì¤‘íˆ ì—¬ê¸°ë©´ í° í–‰ë³µì´ ì°¾ì•„ì˜µë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ì€ í‰ì†Œë³´ë‹¤ ì¡°ê¸ˆ ë” ê³¼ê°í•´ì ¸ë„ ì¢‹ì€ ë‚ ì…ë‹ˆë‹¤.",
            "ì›ƒìŒì€ ê°€ì¥ ê°•ë ¥í•œ ì—ë„ˆì§€ì…ë‹ˆë‹¤. ë§ì´ ì›ƒìœ¼ì„¸ìš”!",
            "ì£¼ë³€ ì‚¬ëŒë“¤ì—ê²Œ ë”°ëœ»í•œ ë§ í•œë§ˆë””ë¥¼ ê±´ë„¤ë³´ì„¸ìš”. ê¸°ì ì´ ì¼ì–´ë‚©ë‹ˆë‹¤.",
            "ì ì‹œ íœ´ì‹ì„ ì·¨í•˜ëŠ” ê²ƒë„ í›Œë¥­í•œ ì „ëµì…ë‹ˆë‹¤.",
            "ë‹¹ì‹ ì˜ ì§ê°ì„ ë¯¿ìœ¼ì„¸ìš”. í•´ë‹µì€ ë‹¹ì‹  ì•ˆì— ìˆìŠµë‹ˆë‹¤.",
            "ê°€ì¡±ê³¼ í•¨ê»˜í•˜ëŠ” ì €ë… ì‹ì‚¬ê°€ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ê²ƒì…ë‹ˆë‹¤.",
            "ê¸°íšŒëŠ” ì¤€ë¹„ëœ ìì—ê²Œ ì°¾ì•„ì˜µë‹ˆë‹¤. ì˜¤ëŠ˜ì´ ê·¸ ì¤€ë¹„ì˜ ë‚ ì…ë‹ˆë‹¤.",
            "ê±±ì •ì€ ë‚´ë ¤ë†“ê³  í˜„ì¬ë¥¼ ì¦ê¸°ì„¸ìš”.",
            "ê°ì‚¬í•˜ëŠ” ë§ˆìŒì´ ë” ë§ì€ ê°ì‚¬í•  ì¼ì„ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤."
        ];

        const dailyKeywords = [
            "í™œê¸°ì°¬ ì—ë„ˆì§€ë¡œ ê°€ë“í•œ í•˜ë£¨! ìƒˆë¡œìš´ ë„ì „ì„ ì‹œì‘í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤.",
            "ì°¨ë¶„í•œ ë§ˆìŒìœ¼ë¡œ ë‚´ë©´ì„ ëŒì•„ë³´ê¸° ì¢‹ì€ ë‚ ì…ë‹ˆë‹¤. ëª…ìƒì„ ì¶”ì²œí•´ìš”.",
            "ì˜ˆê¸°ì¹˜ ì•Šì€ í–‰ìš´ì´ ê¸°ë‹¤ë¦¬ê³  ìˆì„ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤. ì£¼ë³€ì„ ì˜ ì‚´í´ë³´ì„¸ìš”.",
            "ì†Œí†µì´ ì¤‘ìš”í•œ ë‚ ì…ë‹ˆë‹¤. ì˜¤í•´ë¥¼ í’€ê±°ë‚˜ ëŒ€í™”ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.",
            "ì°½ì˜ë ¥ì´ ìƒ˜ì†ŸëŠ” ë‚ ! ì•„ì´ë””ì–´ë¥¼ ë©”ëª¨í•´ë³´ì„¸ìš”.",
            "ê±´ê°• ê´€ë¦¬ì— ìœ ì˜í•˜ì„¸ìš”. ìŠ¤íŠ¸ë ˆì¹­ì´ë‚˜ ê°€ë²¼ìš´ ìš´ë™ì´ ì¢‹ìŠµë‹ˆë‹¤.",
            "ì¬ì •ì ì¸ ë“ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¼¼ê¼¼íˆ ì±™ê²¨ë³´ì„¸ìš”.",
            "ì‚¬ë‘ìš´ì´ ìƒìŠ¹ì„¸ì…ë‹ˆë‹¤. ì†Œì¤‘í•œ ì‚¬ëŒê³¼ ì‹œê°„ì„ ë³´ë‚´ì„¸ìš”."
        ];

        let membersData = []; // [{name, birthdate, ...}]
        let chartTotal = null;
        let chartInd = null;

        // Init
        const today = new Date();
        document.getElementById('header-date').innerText = `${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;

        // Random Cookie
        document.getElementById('fortune-cookie-msg').innerText = `"${fortuneCookies[today.getDate() % fortuneCookies.length]}"`;

        auth.onAuthStateChanged(user => {
            if (!user) {
                location.href = '../login.html';
            } else {
                loadFamilyData(user);
            }
        });

        async function loadFamilyData(user) {
            try {
                // Static family data from users.js is more reliable for birthdates
                // But we still want to know who is "registered" or display order?
                // For this request, user explicitly asked for kukky, soony, joowon, raim
                // We will use Object.keys(familyData) as the source of truth for the chart.

                // However, we normally fetch 'mbti_results' to get dynamic names. 
                // Let's mix them. Use familyData keys.

                const names = Object.keys(familyData);
                membersData = names.map(name => ({
                    name: name,
                    birthdate: familyData[name].birthdate
                }));

                // Initial Render (Total Tab)
                renderTabs();
                renderTotalChart();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
            }
        }

        function renderTabs() {
            const container = document.getElementById('tab-nav');
            // Keep the static 'Total' tab, add others

            membersData.forEach((m, idx) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = m.name;
                btn.onclick = () => switchTab(idx); // Use index as ID for individuals
                container.appendChild(btn);
            });
        }

        // Expose to window
        window.switchTab = function (tabId) {
            // UI Toggle
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach((b, i) => {
                // Total is index 0 conceptually in button list if we querySelectorAll?
                // Actually tabId 'total' is special.

                // Let's rely on text content matching or something simpler
                // Re-implementation: just reset all, set clicked active
                b.classList.remove('active');
            });

            // It's hard to map click directly to element without event, so let's cheat.
            // We'll iterate and find which one was clicked? No, let's pass event or use simple logic.
            // Simplified: Re-render tabs? No.

            // Let's just find the button based on text logic or pass `this`?
            // "window.switchTab" called from inline onclick doesn't pass `this` easily unless specified.
            // Let's look at event.target
            const clickedBtn = event.target;
            clickedBtn.classList.add('active');

            if (tabId === 'total') {
                document.getElementById('section-total').classList.remove('hidden');
                document.getElementById('section-individual').classList.add('hidden');
                // Ensure chart paints
                renderTotalChart();
            } else {
                document.getElementById('section-total').classList.add('hidden');
                document.getElementById('section-individual').classList.remove('hidden');
                renderIndividual(membersData[tabId]);
            }
        }

        function getBiorhythm(birthStr, targetDate) {
            const birth = new Date(birthStr);
            const diffTime = targetDate - birth;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            const phys = Math.sin(2 * Math.PI * diffDays / 23) * 100;
            const emo = Math.sin(2 * Math.PI * diffDays / 28) * 100;
            const intel = Math.sin(2 * Math.PI * diffDays / 33) * 100;

            return { phys, emo, intel, avg: (phys + emo + intel) / 3 };
        }

        function renderTotalChart() {
            if (chartTotal) chartTotal.destroy();

            const labels = [];
            const dataScores = [];
            const bgColors = [];

            // Sort by score? Or fixed order? Fixed order is better for consistency.
            // let's just use original order.

            membersData.forEach(m => {
                if (!m.birthdate) return;
                const bio = getBiorhythm(m.birthdate, new Date());
                labels.push(m.name);
                dataScores.push(bio.avg);
                // Color based on score
                if (bio.avg > 50) bgColors.push('#22c55e'); // Green
                else if (bio.avg > 0) bgColors.push('#fbbf24'); // Yellow
                else bgColors.push('#ef4444'); // Red
            });

            // Find max score for comment
            let maxScore = -100;
            let bestMember = "";
            dataScores.forEach((s, i) => {
                if (s > maxScore) { maxScore = s; bestMember = labels[i]; }
            });

            document.getElementById('total-comment').innerText =
                `ì˜¤ëŠ˜ ì»¨ë””ì…˜ ì™•ì€ ğŸ‘‘ ${bestMember}ë‹˜! (${Math.round(maxScore)}ì )`;

            const ctx = document.getElementById('totalChart').getContext('2d');
            chartTotal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¢…í•© ì»¨ë””ì…˜ ì ìˆ˜',
                        data: dataScores,
                        backgroundColor: bgColors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: -100, max: 100, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderIndividual(member) {
            if (!member || !member.birthdate) return;

            document.getElementById('ind-name-title').innerText = `${member.name}ë‹˜ì˜ ìš´ì„¸`;

            // 1. Text Info
            const z1 = getZodiac(member.birthdate);
            const z2 = getChineseZodiac(member.birthdate);
            document.getElementById('zodiac-text').innerText = `${z1} / ${z2}`;

            // Simple hash for keyword
            const dateVal = new Date().getDate();
            const nameLen = member.name.length;
            const keyIdx = (dateVal + nameLen) % dailyKeywords.length;
            document.getElementById('daily-keyword').innerText = dailyKeywords[keyIdx];

            // 2. Chart
            if (chartInd) chartInd.destroy();

            const labels = [];
            const dP = [], dE = [], dI = [];
            const today = new Date();

            // -3 to +3 days
            for (let i = -3; i <= 3; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                labels.push(`${d.getMonth() + 1}/${d.getDate()}`);

                const bio = getBiorhythm(member.birthdate, d);
                dP.push(bio.phys);
                dE.push(bio.emo);
                dI.push(bio.intel);
            }

            const ctx = document.getElementById('indChart').getContext('2d');
            chartInd = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ì‹ ì²´', data: dP, borderColor: '#22c55e', tension: 0.4, pointRadius: 3 },
                        { label: 'ê°ì„±', data: dE, borderColor: '#ef4444', tension: 0.4, pointRadius: 3 },
                        { label: 'ì§€ì„±', data: dI, borderColor: '#3b82f6', tension: 0.4, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: -100, max: 100, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>

</html>