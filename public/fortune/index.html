<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Garden - ì˜¤ëŠ˜ì˜ ìš´ì„¸ & ë°”ì´ì˜¤ë¦¬ë“¬</title>
    <link rel="stylesheet" href="../../assets/css/style.css?v=14">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .fortune-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .fortune-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .zodiac-badge {
            background: var(--color-lemon);
            color: #d97706;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: #fff;
            color: #666;
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .bio-legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Scratch Card Styles */
        .scratch-wrapper {
            position: relative;
            width: 100%;
            height: 150px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            user-select: none;
            touch-action: none;
        }

        .fortune-cookie-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fffbf0, #fff);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 40px;
            text-align: center;
            font-size: 1.1rem;
            color: #333;
            font-weight: bold;
            line-height: 1.5;
            z-index: 1;
            overflow: hidden;
            box-sizing: border-box;
            /* Crucial Fix */
        }

        .fortune-cookie-content span {
            word-break: keep-all;
            max-width: 100%;
        }

        canvas#scratchCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            /* Cover content */
            cursor: pointer;
        }

        .scratch-hint {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            z-index: 3;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <a href="../dashboard.html" class="logo">â† Secret Garden</a>
            <span>ìš´ì„¸ & ë°”ì´ì˜¤ë¦¬ë“¬</span>
        </header>

        <div id="loading" class="p-4 text-center">ë°ì´í„° ë¡œë”©ì¤‘...</div>

        <!-- Main Content (Hidden until loaded) -->
        <div id="content" class="p-4 hidden">

            <div class="text-center" style="margin-bottom: 20px;">
                <h2 style="font-size: 1.3rem; color: var(--color-primary); margin-bottom: 5px;">
                    <span id="header-date"></span>ì˜ ìš´ì„¸
                </h2>
                <p style="color: #666; font-size: 0.9rem;">ìš°ë¦¬ ê°€ì¡±ì˜ ì˜¤ëŠ˜ ì»¨ë””ì…˜ì€?</p>
            </div>

            <!-- TAB Navigation -->
            <div class="tab-container" id="tab-nav">
                <button class="tab-btn active" onclick="switchTab('total')">ğŸ“Š ê°€ì¡± ì¢…í•©</button>
            </div>

            <!-- 1. Total View Section -->
            <div id="section-total">
                <div class="fortune-card">
                    <h3 class="card-title">ğŸ“ˆ ê°€ì¡± ì»¨ë””ì…˜ ë­í‚¹</h3>
                    <p style="font-size:0.8rem; color:#888; margin-bottom:15px;">ì˜¤ëŠ˜ì˜ ì‹ ì²´/ê°ì„±/ì§€ì„± í‰ê·  ì ìˆ˜ì…ë‹ˆë‹¤.</p>
                    <div style="height: 250px;">
                        <canvas id="totalChart"></canvas>
                    </div>
                    <div class="text-center mt-3" id="total-comment" style="font-size:0.9rem; color:#333;">
                        ë¶„ì„ ì¤‘...
                    </div>
                </div>
            </div>

            <!-- 2. Individual View Section -->
            <div id="section-individual" class="hidden">
                <!-- Data for specific user -->
                <div class="fortune-card">
                    <div class="fortune-header">
                        <span class="card-title" style="margin:0;" id="ind-name-title">ë©¤ë²„ ì´ë¦„</span>
                        <span id="zodiac-text" class="zodiac-badge">ë³„ìë¦¬ / ë </span>
                    </div>

                    <!-- Text Fortune -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="font-size: 0.95rem; margin-bottom: 8px; color: var(--color-secondary);">ğŸŒŸ ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ
                        </h4>
                        <p id="daily-keyword" style="font-size: 0.9rem; color: #555; margin-bottom: 0;">ë¡œë”© ì¤‘...</p>
                    </div>

                    <h3 class="card-title">ğŸ§¬ ë°”ì´ì˜¤ë¦¬ë“¬ ìƒì„¸</h3>
                    <div style="height: 200px; position: relative;">
                        <canvas id="indChart"></canvas>
                    </div>
                    <div class="bio-legend">
                        <div class="legend-item"><span class="dot" style="background:#22c55e"></span>ì‹ ì²´</div>
                        <div class="legend-item"><span class="dot" style="background:#ef4444"></span>ê°ì„±</div>
                        <div class="legend-item"><span class="dot" style="background:#3b82f6"></span>ì§€ì„±</div>
                    </div>
                </div>

                <!-- Individual Scratch Card -->
                <div class="fortune-card" style="background: linear-gradient(135deg, #fff, #fdfbf7);">
                    <h3 class="card-title" style="text-align: center;">ğŸ¥  ì˜¤ëŠ˜ì˜ í¬ì¶˜ ì¿ í‚¤ (ê¸ì–´ë³´ì„¸ìš”!)</h3>

                    <div class="scratch-wrapper" id="scratch-wrapper">
                        <div class="fortune-cookie-content">
                            <span id="fortune-msg">í–‰ìš´ì˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”</span>
                        </div>
                        <canvas id="scratchCanvas"></canvas>
                        <div class="scratch-hint" id="scratch-hint">ğŸ‘† ìŠ¥ìŠ¥ ê¸ì–´ë³´ì„¸ìš”!</div>
                    </div>
                </div>
            </div>

            <!-- Shared Scratch Card Message for Total Tab (Hidden in Individual) -->
            <div id="total-scratch-section" class="fortune-card"
                style="background: linear-gradient(135deg, #fff, #fdfbf7);">
                <p style="text-align: center; color:#888;">ğŸ‘† <strong>ê°œì¸ë³„ íƒ­</strong>ì—ì„œ ê°ìì˜ í¬ì¶˜ ì¿ í‚¤ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>
            </div>

        </div>
    </div>

    <script type="module">
        import { auth, db } from '../../src/firebase.js?v=7';
        import { getZodiac, getChineseZodiac, familyData } from '../../src/users.js?v=6';

        // Expanded Data 
        const fortuneCookies = [
            // ğŸ€ ë§ˆìŒ & ê°ì • (8)
            "ì‘ì€ íœ´ì‹ì´ í° í‰ì˜¨ì„ ê°€ì ¸ì˜¬ ê²ƒì…ë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ì˜ ë§ˆìŒê°€ì§ì´ í•˜ë£¨ì˜ ë°ê¸°ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.",
            "ê±±ì •ë³´ë‹¤ëŠ” ê°€ëŠ¥ì„±ì— ì§‘ì¤‘í•´ë³´ì„¸ìš”.",
            "ê°ì‚¬í•˜ëŠ” ë§ˆìŒì´ ì¢‹ì€ ê¸°ìš´ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.",
            "ë‹¹ì‹ ì˜ ë¯¸ì†Œ í•˜ë‚˜ë¡œ ë¶„ìœ„ê¸°ê°€ ë”°ëœ»í•´ì§‘ë‹ˆë‹¤.",
            "ì²œì²œíˆ ê°€ë„ ê´œì°®ìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ê±´ ê³„ì† ë‚˜ì•„ê°€ëŠ” ê²ƒì…ë‹ˆë‹¤.",
            "ë§ˆìŒì„ ê°€ë³ê²Œ ë¹„ìš°ë©´ ì¢‹ì€ ì¼ì´ ë“¤ì–´ì˜µë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ì€ ê¸°ë¶„ ì¢‹ì€ ì¼ì´ ì¡°ìš©íˆ ì°¾ì•„ì˜¤ëŠ” ë‚ ì…ë‹ˆë‹¤.",

            // ğŸ‘ª ê°€ì¡± & ê´€ê³„ (8)
            "ê°€ì¡±ê³¼ ë‚˜ëˆ„ëŠ” ì‘ì€ ëŒ€í™”ê°€ í° í˜ì´ ë©ë‹ˆë‹¤.",
            "í•¨ê»˜ ì›ƒëŠ” ì‹œê°„ì´ ëª¨ë‘ì—ê²Œ í–‰ìš´ì´ ë©ë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ì€ ë”°ëœ»í•œ ë§ í•œë§ˆë””ê°€ ê´€ê³„ë¥¼ ë” ë‹¨ë‹¨í•˜ê²Œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.",
            "ëˆ„êµ°ê°€ì—ê²Œ ë¨¼ì € ë‹¤ê°€ê°€ë©´ ìƒê°ë³´ë‹¤ ì¢‹ì€ ë°˜ì‘ì´ ëŒì•„ì˜µë‹ˆë‹¤.",
            "ì‘ì€ ë°°ë ¤ê°€ ì„œë¡œì˜ í•˜ë£¨ë¥¼ ë°ê²Œ í•´ì¤ë‹ˆë‹¤.",
            "ì˜¤ë˜ëœ ì¸ì—°ì—ê²Œ ì—°ë½í•˜ë©´ ì¢‹ì€ ê¸°ìš´ì„ ë°›ê²Œ ë©ë‹ˆë‹¤.",
            "ì„œë¡œë¥¼ ì´í•´í•˜ë ¤ëŠ” ë§ˆìŒì´ ì¢‹ì€ íë¦„ì„ ë§Œë“­ë‹ˆë‹¤.",
            "ì§„ì‹¬ì€ ì‹œê°„ì´ ì§€ë‚˜ë„ ë°˜ë“œì‹œ ì „í•´ì§‘ë‹ˆë‹¤.",

            // ğŸš€ ë„ì „ & ì„±ì·¨ (8)
            "ì˜¤ëŠ˜ì€ ì‹œì‘í•˜ê¸°ì— ì•„ì£¼ ì¢‹ì€ ë‚ ì…ë‹ˆë‹¤.",
            "ì§€ê¸ˆì˜ ë…¸ë ¥ì´ ê³§ ê²°ì‹¤ë¡œ ëŒì•„ì˜¬ ê²ƒì…ë‹ˆë‹¤.",
            "í•œ ê±¸ìŒ ë‚´ë”›ìœ¼ë©´ ìƒê°ë³´ë‹¤ ë§ì€ ê²ƒì´ ì—´ë¦½ë‹ˆë‹¤.",
            "ê¸°íšŒëŠ” ì¤€ë¹„ëœ ìˆœê°„ì— ìì—°ìŠ¤ëŸ½ê²Œ ì°¾ì•„ì˜µë‹ˆë‹¤.",
            "ì‘ê²Œë¼ë„ í•´ë³´ë©´ í° ë³€í™”ê°€ ì‹œì‘ë©ë‹ˆë‹¤.",
            "ìš©ê¸° ìˆëŠ” ì„ íƒì´ ê¸ì •ì ì¸ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.",
            "í˜„ì¬ì˜ ì„±ì‹¤í•¨ì´ ë¯¸ë˜ì˜ ë“ ë“ í•œ í˜ì´ ë©ë‹ˆë‹¤.",
            "ë‹¹ì‹ ì´ ìƒê°í•˜ëŠ” ê²ƒë³´ë‹¤ í›¨ì”¬ ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.",

            // ğŸŒ± ì„±ì¥ & ê¹¨ë‹¬ìŒ (8)
            "ì‹¤ìˆ˜ëŠ” ë°°ì›€ì˜ ì¼ë¶€ì¼ ë¿ì…ë‹ˆë‹¤. ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ì„¸ìš”.",
            "ì˜¤ëŠ˜ì˜ ì„ íƒì´ ë” ë‚˜ì€ ë‚´ì¼ì„ ë§Œë“­ë‹ˆë‹¤.",
            "ë°°ìš°ë ¤ëŠ” ë§ˆìŒì´ í–‰ìš´ì„ ë°ë ¤ì˜µë‹ˆë‹¤.",
            "ìƒˆë¡œìš´ ì‹œë„ê°€ ìƒˆë¡œìš´ ë¬¸ì„ ì—½ë‹ˆë‹¤.",
            "ë³€í™”ëŠ” ë‘ë ¤ì›€ë³´ë‹¤ ì„±ì¥ì˜ ê¸°íšŒê°€ ë” ë§ìŠµë‹ˆë‹¤.",
            "ì¡°ê¸ˆë§Œ ì‹œê°ì„ ë‹¬ë¦¬ ë³´ë©´ ë‹µì´ ë³´ì…ë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ ëŠë‚€ ì‘ì€ ê¹¨ë‹¬ìŒì´ í° ì§€í˜œê°€ ë©ë‹ˆë‹¤.",
            "ê¾¸ì¤€í•¨ì€ ì–´ë–¤ ì¬ëŠ¥ë³´ë‹¤ ê°•ë ¥í•œ í˜ì…ë‹ˆë‹¤.",

            // ğŸŒ ì¼ìƒ ì† í–‰ìš´ (8)
            "ì˜ˆìƒì¹˜ ëª»í•œ ì¦ê±°ìš´ ì¼ì´ ì˜¤ëŠ˜ì„ ì°¾ì•„ì˜µë‹ˆë‹¤.",
            "í‰ë²”í•œ ìˆœê°„ì´ íŠ¹ë³„í•´ì§€ëŠ” í•˜ë£¨ê°€ ë  ê²ƒì…ë‹ˆë‹¤.",
            "ì¢‹ì€ ì†Œì‹ì´ ìƒê°ë³´ë‹¤ ê°€ê¹Œì´ ì™€ ìˆìŠµë‹ˆë‹¤.",
            "ê¸°ëŒ€í•˜ì§€ ì•Šì€ ê³³ì—ì„œ ë„ì›€ì´ ì°¾ì•„ì˜µë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ì€ ëª¨ë“  ì¼ì´ ìˆœì¡°ë¡­ê²Œ ì§„í–‰ë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.",
            "ì‘ì€ ì„ íƒ í•˜ë‚˜ê°€ í° í–‰ìš´ìœ¼ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤.",
            "ì£¼ë³€ì„ ë‘˜ëŸ¬ë³´ë©´ ì´ë¯¸ ë§ì€ í–‰ìš´ì´ í•¨ê»˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ì¡°ìš©í•œ í–‰ë³µì´ í•˜ë£¨ ì „ì²´ì— í¼ì ¸ ìˆì„ ê²ƒì…ë‹ˆë‹¤."
        ];

        const dailyKeywords = [
            // ğŸ’ª í™œë ¥ & ê±´ê°• (8)
            "ê°€ë²¼ìš´ ìš´ë™ì´ í° í™œë ¥ì„ ì£¼ëŠ” ë‚  ğŸƒ",
            "ëª¸ê³¼ ë§ˆìŒì´ ë™ì‹œì— ê°€ë²¼ì›Œì§€ëŠ” í•˜ë£¨ ğŸŒ¿",
            "ì»¨ë””ì…˜ì´ ì¢‹ì•„ì„œ ë¬´ì—‡ì´ë“  ì˜ ë˜ëŠ” íë¦„ ğŸ’§",
            "ê·œì¹™ì ì¸ ë¦¬ë“¬ì´ í•˜ë£¨ë¥¼ ë” ì•ˆì •ì ìœ¼ë¡œ ë§Œë“¤ì–´ìš” â±ï¸",
            "ì§§ì€ ì‚°ì±…ë§Œìœ¼ë¡œë„ ê¸°ë¶„ì´ í™˜í•´ì§€ëŠ” ë‚  ğŸš¶",
            "ì˜¤ëŠ˜ì€ íœ´ì‹ê³¼ í™œë™ì˜ ê· í˜•ì´ ì¤‘ìš”í•´ìš” âš–ï¸",
            "ìŒì‹ê³¼ ìˆ˜ë¶„ ê´€ë¦¬ê°€ ì¢‹ì€ ì˜í–¥ì„ ì£¼ëŠ” ë‚  ğŸ",
            "ëª¸ì´ ë¶€ë“œëŸ½ê²Œ í’€ë¦¬ëŠ” íë§ ë°ì´ ğŸ’†",

            // ğŸ˜Š ê°ì • & ë§ˆìŒ ì±™ê¹€ (8)
            "ê¸°ë¶„ ì „í™˜ì´ í•„ìš”í•˜ë‹¤ë©´ ì‘ì€ ë³€í™”ê°€ íš¨ê³¼ì ì´ì—ìš” âœ¨",
            "ë§ˆìŒì´ í•œê²° í¸ì•ˆí•´ì§€ëŠ” ì°¨ë¶„í•œ íë¦„ â˜•",
            "í‰ì†Œë³´ë‹¤ ì—¬ìœ ê°€ ìƒê²¨ ìƒê°ì´ ì •ë¦¬ë˜ëŠ” ë‚  ğŸ§˜",
            "ê°ì •ì˜ íŒŒë„ê°€ ì”ì”í•´ì§€ëŠ” ì•ˆì •ì˜ í•˜ë£¨ ğŸŒŠ",
            "ê°€ë³ê²Œ ì›ƒì„ ì¼ì´ ìƒê¸¸ ìˆ˜ ìˆëŠ” í¸ì•ˆí•œ ë‚  ğŸŒ¼",
            "ë°”ìœ ì™€ì¤‘ì—ë„ ìˆ¨ ê³ ë¥´ê¸°ê°€ ì˜ ì–´ìš¸ë¦¬ëŠ” í•˜ë£¨ ğŸŒ¬ï¸",
            "ìŠ¤ìŠ¤ë¡œì—ê²Œ ì¡°ê¸ˆ ë” ì¹œì ˆí•´ì§€ê¸° ì¢‹ì€ ë‚  ğŸ¤—",
            "ë§ˆìŒì˜ ì•ˆì •ì„ ì£¼ëŠ” ì†Œì†Œí•œ í–‰ë³µì´ ì°¾ì•„ì™€ìš” ğŸŒ™",

            // ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê´€ê³„ & ì†Œí†µ (8)
            "ëŒ€í™”ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ì˜ ì´ì–´ì§€ëŠ” ì†Œí†µì˜ ë‚  ğŸ—£ï¸",
            "í•¨ê»˜í•˜ëŠ” ì‹œê°„ì´ í° ì˜ë¯¸ë¥¼ ì£¼ëŠ” í•˜ë£¨ ğŸ‘ª",
            "ì‘ì€ ë°°ë ¤ê°€ ì„œë¡œì—ê²Œ í–‰ë³µì„ ì „í•´ìš” ğŸ¤",
            "ë”°ëœ»í•œ ë§ í•œë§ˆë””ê°€ ë¶„ìœ„ê¸°ë¥¼ ë°”ê¿‰ë‹ˆë‹¤ ğŸ’¬",
            "ê°€ê¹Œìš´ ì‚¬ëŒë“¤ê³¼ì˜ ê³µê°ì´ ê¹Šì–´ì§€ëŠ” ë‚  ğŸ’›",
            "ì£¼ê³ ë°›ëŠ” ë§ˆìŒì´ ë”ìš± í’ì„±í•´ì§€ëŠ” í•˜ë£¨ ğŸ",
            "í˜‘ë ¥ì´ ìì—°ìŠ¤ë ˆ ì´ë£¨ì–´ì§€ëŠ” ì¢‹ì€ íë¦„ ğŸ¤—",
            "ëˆ„êµ°ê°€ì™€ ë” ê°€ê¹Œì›Œì§€ëŠ” í¸ì•ˆí•œ í•˜ë£¨ ğŸŒ¤ï¸",

            // ğŸš€ ì§‘ì¤‘ & ì„±ì·¨ (8)
            "ì§‘ì¤‘ë ¥ì´ ë†’ì•„ì ¸ ê³„íší•œ ì¼ì„ ë¹ ë¥´ê²Œ ëë‚¼ ìˆ˜ ìˆì–´ìš” ğŸ“š",
            "ì‘ì€ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê¸° ì¢‹ì€ ë‚  âœ”ï¸",
            "ì •ë¦¬ì •ëˆì´ ì˜ ë˜ì–´ íë¦„ì´ ì •ëˆë˜ëŠ” í•˜ë£¨ ğŸ§¹",
            "ì•„ì´ë””ì–´ê°€ ì„ ëª…í•˜ê²Œ ë– ì˜¤ë¥´ëŠ” ì°½ì˜ì  ìˆœê°„ ğŸ’¡",
            "íš¨ìœ¨ì´ ì¢‹ì•„ì„œ ì‹œê°„ì´ ì•Œì°¨ê²Œ ëŠê»´ì§€ëŠ” ë‚  â³",
            "í‰ì†Œ ë¯¸ë¤˜ë˜ ì‘ì—…ì„ í•˜ê¸°ì— ìµœì ì˜ í•˜ë£¨ ğŸ”§",
            "ìƒˆë¡œìš´ ì‹œë„ë¥¼ í•˜ê¸°ì— ë¶€ë‹´ ì—†ëŠ” í¸ì•ˆí•œ ë‚  ğŸ”",
            "ë‹¨ìˆœí•œ ì¼ë¶€í„° ì°¨ê·¼ì°¨ê·¼ í’€ì–´ë‚˜ê°€ê¸° ì¢‹ì€ í•˜ë£¨ ğŸ”—"
        ];


        let membersData = [];
        let chartTotal = null;
        let chartInd = null;
        let scratchCanvas = null;
        let scratchCtx = null;
        let isDrawing = false;
        let currentScratchMember = null;

        // Init
        const today = new Date();
        document.getElementById('header-date').innerText = `${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;

        auth.onAuthStateChanged(user => {
            if (!user) {
                location.href = '../login.html';
            } else {
                loadFamilyData(user);
            }
        });

        // Simple seeded random function
        function seededRandom(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            const x = Math.sin(hash) * 10000;
            return x - Math.floor(x);
        }

        async function loadFamilyData(user) {
            try {
                const names = Object.keys(familyData);
                membersData = names.map(name => ({
                    name: name,
                    birthdate: familyData[name].birthdate
                }));

                renderTabs();
                renderTotalChart();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
            }
        }

        function renderTabs() {
            const container = document.getElementById('tab-nav');
            // Keep the static 'Total' tab, add others

            membersData.forEach((m, idx) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = m.name;
                btn.onclick = (e) => switchTab(idx, e);
                container.appendChild(btn);
            });
        }

        window.switchTab = function (tabId, event) {
            // UI Toggle
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(b => b.classList.remove('active'));

            if (event) {
                event.target.classList.add('active');
            } else {
                // Fallback or Initial
            }

            if (tabId === 'total') {
                document.getElementById('section-total').classList.remove('hidden');
                document.getElementById('section-individual').classList.add('hidden');
                document.getElementById('total-scratch-section').classList.remove('hidden'); // Show Guide
                renderTotalChart();
            } else {
                document.getElementById('section-total').classList.add('hidden');
                document.getElementById('section-individual').classList.remove('hidden');
                document.getElementById('total-scratch-section').classList.add('hidden'); // Hide Guide
                renderIndividual(membersData[tabId]);
            }
        }

        function getBiorhythm(birthStr, targetDate) {
            const birth = new Date(birthStr);
            const diffTime = targetDate - birth;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            const phys = Math.sin(2 * Math.PI * diffDays / 23) * 100;
            const emo = Math.sin(2 * Math.PI * diffDays / 28) * 100;
            const intel = Math.sin(2 * Math.PI * diffDays / 33) * 100;

            return { phys, emo, intel, avg: (phys + emo + intel) / 3 };
        }

        function renderTotalChart() {
            if (chartTotal) chartTotal.destroy();

            const labels = [];
            const dataScores = [];
            const bgColors = [];

            membersData.forEach(m => {
                if (!m.birthdate) return;
                const bio = getBiorhythm(m.birthdate, new Date());
                labels.push(m.name);
                dataScores.push(bio.avg);

                if (bio.avg > 50) bgColors.push('#22c55e');
                else if (bio.avg > 0) bgColors.push('#fbbf24');
                else bgColors.push('#ef4444');
            });

            let maxScore = -100;
            let bestMember = "";
            dataScores.forEach((s, i) => {
                if (s > maxScore) { maxScore = s; bestMember = labels[i]; }
            });

            document.getElementById('total-comment').innerText =
                `ì˜¤ëŠ˜ ì»¨ë””ì…˜ ì™•ì€ ğŸ‘‘ ${bestMember}ë‹˜! (${Math.round(maxScore)}ì )`;

            const ctx = document.getElementById('totalChart').getContext('2d');
            chartTotal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¢…í•© ì»¨ë””ì…˜ ì ìˆ˜',
                        data: dataScores,
                        backgroundColor: bgColors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: -100, max: 100, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderIndividual(member) {
            if (!member || !member.birthdate) return;

            document.getElementById('ind-name-title').innerText = `${member.name}ë‹˜ì˜ ìš´ì„¸`;

            // 1. Static Info (Zodiac)
            const z1 = getZodiac(member.birthdate);
            const z2 = getChineseZodiac(member.birthdate);
            document.getElementById('zodiac-text').innerText = `${z1} / ${z2}`;

            // 2. Daily Keyword (Seeded by Name + Date)
            const dateStr = `${today.getFullYear()}${today.getMonth()}${today.getDate()}`;
            const seed = member.name + dateStr;
            const randVal = seededRandom(seed);

            const keyIdx = Math.floor(randVal * dailyKeywords.length);
            document.getElementById('daily-keyword').innerText = dailyKeywords[keyIdx];

            // 3. Fortune Cookie (Seeded by Name + Date + 'cookie')
            const cookieSeed = seed + 'cookie';
            const cookieRand = seededRandom(cookieSeed);
            const cookieIdx = Math.floor(cookieRand * fortuneCookies.length);

            document.getElementById('fortune-msg').innerText = `"${fortuneCookies[cookieIdx]}"`;

            // 4. Scratch Canvas Reset
            initScratchCanvas(member.name); // Reset scratch for this user

            // 5. Bio Chart
            if (chartInd) chartInd.destroy();

            const labels = [];
            const dP = [], dE = [], dI = [];
            const todayD = new Date();

            for (let i = -3; i <= 3; i++) {
                const d = new Date(todayD);
                d.setDate(todayD.getDate() + i);
                labels.push(`${d.getMonth() + 1}/${d.getDate()}`);

                const bio = getBiorhythm(member.birthdate, d);
                dP.push(bio.phys);
                dE.push(bio.emo);
                dI.push(bio.intel);
            }

            const ctx = document.getElementById('indChart').getContext('2d');
            chartInd = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ì‹ ì²´', data: dP, borderColor: '#22c55e', tension: 0.4, pointRadius: 3 },
                        { label: 'ê°ì„±', data: dE, borderColor: '#ef4444', tension: 0.4, pointRadius: 3 },
                        { label: 'ì§€ì„±', data: dI, borderColor: '#3b82f6', tension: 0.4, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: -100, max: 100, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Scratch Logic ---
        function initScratchCanvas(memberName) {
            // Need to check if user switched tab, scratch should be reset? 
            // Yes, user wants "scratch card" experience effectively per member view.

            const canvas = document.getElementById('scratchCanvas');
            const parent = document.getElementById('scratch-wrapper');
            const hint = document.getElementById('scratch-hint');

            if (!canvas || !parent) return;

            scratchCtx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = parent.offsetWidth;
            canvas.height = parent.offsetHeight;

            // Fill with gray/silver
            scratchCtx.globalCompositeOperation = 'source-over';
            scratchCtx.fillStyle = '#cccccc'; // silver
            scratchCtx.fillRect(0, 0, canvas.width, canvas.height);

            // Decoration text "Scratch Me"
            scratchCtx.fillStyle = '#999';
            scratchCtx.font = '20px sans-serif';
            scratchCtx.textAlign = 'center';
            scratchCtx.fillText("ğŸ€ ê¸ì–´ì„œ í–‰ìš´ í™•ì¸!", canvas.width / 2, canvas.height / 2);

            // Reset Drawing State
            isDrawing = false;
            hint.style.display = 'block'; // Show hint again

            // Event Listeners (ensure we don't duplicate if called multiple times)
            // It's safer to recreate or remove old listeners, but for simplicity here we assume simple switching.
            // Using 'on' properties to override previous handlers easily.

            canvas.onmousedown = startScratch;
            canvas.onmousemove = scratch;
            canvas.onmouseup = endScratch;
            canvas.onmouseleave = endScratch;

            // Touch support
            canvas.ontouchstart = (e) => { e.preventDefault(); startScratch(e.touches[0]); };
            canvas.ontouchmove = (e) => { e.preventDefault(); scratch(e.touches[0]); };
            canvas.ontouchend = endScratch;
        }

        function startScratch(e) {
            isDrawing = true;
            document.getElementById('scratch-hint').style.display = 'none'; // Hide hint once started
            scratch(e);
        }

        function scratch(e) {
            if (!isDrawing) return;

            const canvas = document.getElementById('scratchCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            scratchCtx.globalCompositeOperation = 'destination-out';
            scratchCtx.beginPath();
            scratchCtx.arc(x, y, 20, 0, Math.PI * 2); // Brush size
            scratchCtx.fill();
        }

        function endScratch() {
            isDrawing = false;
            // Check percent cleared? (Optional enhancement)
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            // Ideally resize canvas but that would clear it. Let's ignore for MVP.
        });

    </script>
</body>

</html>