<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Garden - ì˜¤ëŠ˜ì˜ ìš´ì„¸ & ë°”ì´ì˜¤ë¦¬ë“¬</title>
    <link rel="stylesheet" href="../../assets/css/style.css?v=9">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .fortune-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .fortune-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .zodiac-badge {
            background: var(--color-lemon);
            color: #d97706;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: #fff;
            color: #666;
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .bio-legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Scratch Card Styles */
        .scratch-wrapper {
            position: relative;
            width: 100%;
            height: 150px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            user-select: none;
            touch-action: none;
        }

        .fortune-cookie-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fffbf0, #fff);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 40px;
            text-align: center;
            font-size: 1.1rem;
            color: #333;
            font-weight: bold;
            line-height: 1.5;
            z-index: 1;
            overflow: hidden;
            box-sizing: border-box;
            /* Crucial Fix */
        }

        .fortune-cookie-content span {
            word-break: keep-all;
            max-width: 100%;
        }

        canvas#scratchCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            /* Cover content */
            cursor: pointer;
        }

        .scratch-hint {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            z-index: 3;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <a href="../dashboard.html" class="logo">â† Secret Garden</a>
            <span>ìš´ì„¸ & ë°”ì´ì˜¤ë¦¬ë“¬</span>
        </header>

        <div id="loading" class="p-4 text-center">ë°ì´í„° ë¡œë”©ì¤‘...</div>

        <!-- Main Content (Hidden until loaded) -->
        <div id="content" class="p-4 hidden">

            <div class="text-center" style="margin-bottom: 20px;">
                <h2 style="font-size: 1.3rem; color: var(--color-primary); margin-bottom: 5px;">
                    <span id="header-date"></span>ì˜ ìš´ì„¸
                </h2>
                <p style="color: #666; font-size: 0.9rem;">ìš°ë¦¬ ê°€ì¡±ì˜ ì˜¤ëŠ˜ ì»¨ë””ì…˜ì€?</p>
            </div>

            <!-- TAB Navigation -->
            <div class="tab-container" id="tab-nav">
                <button class="tab-btn active" onclick="switchTab('total')">ğŸ“Š ê°€ì¡± ì¢…í•©</button>
            </div>

            <!-- 1. Total View Section -->
            <div id="section-total">
                <div class="fortune-card">
                    <h3 class="card-title">ğŸ“ˆ ê°€ì¡± ì»¨ë””ì…˜ ë­í‚¹</h3>
                    <p style="font-size:0.8rem; color:#888; margin-bottom:15px;">ì˜¤ëŠ˜ì˜ ì‹ ì²´/ê°ì„±/ì§€ì„± í‰ê·  ì ìˆ˜ì…ë‹ˆë‹¤.</p>
                    <div style="height: 250px;">
                        <canvas id="totalChart"></canvas>
                    </div>
                    <div class="text-center mt-3" id="total-comment" style="font-size:0.9rem; color:#333;">
                        ë¶„ì„ ì¤‘...
                    </div>
                </div>
            </div>

            <!-- 2. Individual View Section -->
            <div id="section-individual" class="hidden">
                <!-- Data for specific user -->
                <div class="fortune-card">
                    <div class="fortune-header">
                        <span class="card-title" style="margin:0;" id="ind-name-title">ë©¤ë²„ ì´ë¦„</span>
                        <span id="zodiac-text" class="zodiac-badge">ë³„ìë¦¬ / ë </span>
                    </div>

                    <!-- Text Fortune -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="font-size: 0.95rem; margin-bottom: 8px; color: var(--color-secondary);">ğŸŒŸ ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ
                        </h4>
                        <p id="daily-keyword" style="font-size: 0.9rem; color: #555; margin-bottom: 0;">ë¡œë”© ì¤‘...</p>
                    </div>

                    <h3 class="card-title">ğŸ§¬ ë°”ì´ì˜¤ë¦¬ë“¬ ìƒì„¸</h3>
                    <div style="height: 200px; position: relative;">
                        <canvas id="indChart"></canvas>
                    </div>
                    <div class="bio-legend">
                        <div class="legend-item"><span class="dot" style="background:#22c55e"></span>ì‹ ì²´</div>
                        <div class="legend-item"><span class="dot" style="background:#ef4444"></span>ê°ì„±</div>
                        <div class="legend-item"><span class="dot" style="background:#3b82f6"></span>ì§€ì„±</div>
                    </div>
                </div>

                <!-- Individual Scratch Card -->
                <div class="fortune-card" style="background: linear-gradient(135deg, #fff, #fdfbf7);">
                    <h3 class="card-title" style="text-align: center;">ğŸ¥  ì˜¤ëŠ˜ì˜ í¬ì¶˜ ì¿ í‚¤ (ê¸ì–´ë³´ì„¸ìš”!)</h3>

                    <div class="scratch-wrapper" id="scratch-wrapper">
                        <div class="fortune-cookie-content">
                            <span id="fortune-msg">í–‰ìš´ì˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”</span>
                        </div>
                        <canvas id="scratchCanvas"></canvas>
                        <div class="scratch-hint" id="scratch-hint">ğŸ‘† ìŠ¥ìŠ¥ ê¸ì–´ë³´ì„¸ìš”!</div>
                    </div>
                </div>
            </div>

            <!-- Shared Scratch Card Message for Total Tab (Hidden in Individual) -->
            <div id="total-scratch-section" class="fortune-card"
                style="background: linear-gradient(135deg, #fff, #fdfbf7);">
                <p style="text-align: center; color:#888;">ğŸ‘† <strong>ê°œì¸ë³„ íƒ­</strong>ì—ì„œ ê°ìì˜ í¬ì¶˜ ì¿ í‚¤ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>
            </div>

        </div>
    </div>

    <script type="module">
        import { auth, db } from '../../src/firebase.js?v=7';
        import { getZodiac, getChineseZodiac, familyData } from '../../src/users.js?v=6';

        // Expanded Data (20+ Items)
        const fortuneCookies = [
            "ì‘ì€ í–‰ë³µì„ ì†Œì¤‘íˆ ì—¬ê¸°ë©´ í° í–‰ë³µì´ ì°¾ì•„ì˜µë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ì€ í‰ì†Œë³´ë‹¤ ì¡°ê¸ˆ ë” ê³¼ê°í•´ì ¸ë„ ì¢‹ì€ ë‚ ì…ë‹ˆë‹¤.",
            "ì›ƒìŒì€ ê°€ì¥ ê°•ë ¥í•œ ì—ë„ˆì§€ì…ë‹ˆë‹¤. ë§ì´ ì›ƒìœ¼ì„¸ìš”!",
            "ì£¼ë³€ ì‚¬ëŒë“¤ì—ê²Œ ë”°ëœ»í•œ ë§ í•œë§ˆë””ë¥¼ ê±´ë„¤ë³´ì„¸ìš”. ê¸°ì ì´ ì¼ì–´ë‚©ë‹ˆë‹¤.",
            "ì ì‹œ íœ´ì‹ì„ ì·¨í•˜ëŠ” ê²ƒë„ í›Œë¥­í•œ ì „ëµì…ë‹ˆë‹¤.",
            "ë‹¹ì‹ ì˜ ì§ê°ì„ ë¯¿ìœ¼ì„¸ìš”. í•´ë‹µì€ ë‹¹ì‹  ì•ˆì— ìˆìŠµë‹ˆë‹¤.",
            "ê°€ì¡±ê³¼ í•¨ê»˜í•˜ëŠ” ì €ë… ì‹ì‚¬ê°€ í–‰ìš´ì„ ê°€ì ¸ë‹¤ ì¤„ ê²ƒì…ë‹ˆë‹¤.",
            "ê¸°íšŒëŠ” ì¤€ë¹„ëœ ìì—ê²Œ ì°¾ì•„ì˜µë‹ˆë‹¤. ì˜¤ëŠ˜ì´ ê·¸ ì¤€ë¹„ì˜ ë‚ ì…ë‹ˆë‹¤.",
            "ê±±ì •ì€ ë‚´ë ¤ë†“ê³  í˜„ì¬ë¥¼ ì¦ê¸°ì„¸ìš”.",
            "ê°ì‚¬í•˜ëŠ” ë§ˆìŒì´ ë” ë§ì€ ê°ì‚¬í•  ì¼ì„ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤.",
            "ì˜¤ë˜ëœ ì¹œêµ¬ì—ê²Œ ì—°ë½í•˜ë©´ ì¢‹ì€ ì†Œì‹ì´ ìˆì„ ê²ƒì…ë‹ˆë‹¤.",
            "ì§€ê¸ˆ í•˜ê³  ìˆëŠ” ë…¸ë ¥ì´ ê³§ ê²°ì‹¤ì„ ë§ºì„ ê²ƒì…ë‹ˆë‹¤.",
            "ë³€í™”ëŠ” ë‘ë ¤ìš´ ê²ƒì´ ì•„ë‹ˆë¼ ìƒˆë¡œìš´ ê¸°íšŒì…ë‹ˆë‹¤.",
            "ë‚˜ ìì‹ ì„ ì‚¬ë‘í•˜ëŠ” ê²ƒì´ ëª¨ë“  ì„±ê³µì˜ ì‹œì‘ì…ë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ì€ í‰í™”ë¡­ê³  ì•ˆì •ì ì¸ í•˜ë£¨ê°€ ë  ê²ƒì…ë‹ˆë‹¤.",
            "ëœ»ë°–ì˜ ì„ ë¬¼ì„ ë°›ê±°ë‚˜ ì¢‹ì€ ì œì•ˆì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            "ë‹¹ì‹ ì˜ ë¯¸ì†Œê°€ ëˆ„êµ°ê°€ì˜ í•˜ë£¨ë¥¼ ë°í˜€ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            "ì‹¤ìˆ˜ëŠ” ë°°ì›€ì˜ ê³¼ì •ì¼ ë¿ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”.",
            "ì˜¤ëŠ˜ì€ ê³„íší–ˆë˜ ì¼ì„ ì‹œì‘í•˜ê¸°ì— ì•„ì£¼ ì¢‹ì€ ë‚ ì…ë‹ˆë‹¤.",
            "í–‰ìš´ì˜ ì—¬ì‹ ì´ ë‹¹ì‹ ì˜ í¸ì— ì„œ ìˆìŠµë‹ˆë‹¤."
        ];

        const dailyKeywords = [
            "í™œê¸°ì°¬ ì—ë„ˆì§€! ë„ì „í•˜ê¸° ì¢‹ì€ ë‚  ğŸš€",
            "ì°¨ë¶„í•œ ëª…ìƒì´ í•„ìš”í•œ íë§ë°ì´ ğŸŒ¿",
            "ì˜ˆê¸°ì¹˜ ì•Šì€ í–‰ìš´ì´ ì°¾ì•„ì˜¬ì§€ë„? ğŸ€",
            "ëŒ€í™”ì™€ ì†Œí†µìœ¼ë¡œ ì˜¤í•´ë¥¼ í‘¸ëŠ” ë‚  ğŸ—£ï¸",
            "ì°½ì˜ë ¥ì´ ìƒ˜ì†ŸëŠ” ì•„ì´ë””ì–´ ë±…í¬ ğŸ’¡",
            "ê±´ê°•ì´ ìµœìš°ì„ ! ê°€ë²¼ìš´ ìš´ë™ í•„ìˆ˜ ğŸƒ",
            "ì§€ê°‘ ì¡°ì‹¬! ì¬ì • ê´€ë¦¬ê°€ í•„ìš”í•œ ë‚  ğŸ’°",
            "ì‚¬ë‘ì´ ê½ƒí”¼ëŠ” ë¡œë§¨í‹±í•œ í•˜ë£¨ â¤ï¸",
            "ì§‘ì¤‘ë ¥ì´ ìµœê³ ì¡°! ê³µë¶€ë‚˜ ì—…ë¬´ì— ë”± ğŸ“š",
            "ë§›ìˆëŠ” ìŒì‹ìœ¼ë¡œ ìŠ¤íŠ¸ë ˆìŠ¤ íƒ€íŒŒ ğŸœ",
            "ì£¼ë³€ì˜ ë„ì›€ì„ ë°›ì•„ í•´ê²°ë˜ëŠ” ë‚  ğŸ¤",
            "ìì‹ ê°ì„ ê°€ì§€ê³  ë¦¬ë”ì‹­ì„ ë°œíœ˜í•˜ì„¸ìš” ğŸ¦",
            "ì‘ì€ ì‹¤ìˆ˜ë„ ì›ƒì–´ë„˜ê¸°ëŠ” ì—¬ìœ ê°€ í•„ìš”í•´ìš” ğŸ˜Š",
            "ìŒì•…ê³¼ í•¨ê»˜ ê°ì„±ì„ ì¶©ì „í•´ë³´ì„¸ìš” ğŸµ",
            "ì •ë¦¬ì •ëˆìœ¼ë¡œ ë§ˆìŒê¹Œì§€ ìƒì¾Œí•˜ê²Œ ğŸ§¹",
            "ìƒˆë¡œìš´ ì·¨ë¯¸ë¥¼ ë°œê²¬í•  ìˆ˜ë„ ìˆì–´ìš” ğŸ¨"
        ];

        let membersData = [];
        let chartTotal = null;
        let chartInd = null;
        let scratchCanvas = null;
        let scratchCtx = null;
        let isDrawing = false;
        let currentScratchMember = null;

        // Init
        const today = new Date();
        document.getElementById('header-date').innerText = `${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;

        auth.onAuthStateChanged(user => {
            if (!user) {
                location.href = '../login.html';
            } else {
                loadFamilyData(user);
            }
        });

        // Simple seeded random function
        function seededRandom(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            const x = Math.sin(hash) * 10000;
            return x - Math.floor(x);
        }

        async function loadFamilyData(user) {
            try {
                const names = Object.keys(familyData);
                membersData = names.map(name => ({
                    name: name,
                    birthdate: familyData[name].birthdate
                }));

                renderTabs();
                renderTotalChart();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
            }
        }

        function renderTabs() {
            const container = document.getElementById('tab-nav');
            // Keep the static 'Total' tab, add others

            membersData.forEach((m, idx) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = m.name;
                btn.onclick = (e) => switchTab(idx, e);
                container.appendChild(btn);
            });
        }

        window.switchTab = function (tabId, event) {
            // UI Toggle
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(b => b.classList.remove('active'));

            if (event) {
                event.target.classList.add('active');
            } else {
                // Fallback or Initial
            }

            if (tabId === 'total') {
                document.getElementById('section-total').classList.remove('hidden');
                document.getElementById('section-individual').classList.add('hidden');
                document.getElementById('total-scratch-section').classList.remove('hidden'); // Show Guide
                renderTotalChart();
            } else {
                document.getElementById('section-total').classList.add('hidden');
                document.getElementById('section-individual').classList.remove('hidden');
                document.getElementById('total-scratch-section').classList.add('hidden'); // Hide Guide
                renderIndividual(membersData[tabId]);
            }
        }

        function getBiorhythm(birthStr, targetDate) {
            const birth = new Date(birthStr);
            const diffTime = targetDate - birth;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            const phys = Math.sin(2 * Math.PI * diffDays / 23) * 100;
            const emo = Math.sin(2 * Math.PI * diffDays / 28) * 100;
            const intel = Math.sin(2 * Math.PI * diffDays / 33) * 100;

            return { phys, emo, intel, avg: (phys + emo + intel) / 3 };
        }

        function renderTotalChart() {
            if (chartTotal) chartTotal.destroy();

            const labels = [];
            const dataScores = [];
            const bgColors = [];

            membersData.forEach(m => {
                if (!m.birthdate) return;
                const bio = getBiorhythm(m.birthdate, new Date());
                labels.push(m.name);
                dataScores.push(bio.avg);

                if (bio.avg > 50) bgColors.push('#22c55e');
                else if (bio.avg > 0) bgColors.push('#fbbf24');
                else bgColors.push('#ef4444');
            });

            let maxScore = -100;
            let bestMember = "";
            dataScores.forEach((s, i) => {
                if (s > maxScore) { maxScore = s; bestMember = labels[i]; }
            });

            document.getElementById('total-comment').innerText =
                `ì˜¤ëŠ˜ ì»¨ë””ì…˜ ì™•ì€ ğŸ‘‘ ${bestMember}ë‹˜! (${Math.round(maxScore)}ì )`;

            const ctx = document.getElementById('totalChart').getContext('2d');
            chartTotal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¢…í•© ì»¨ë””ì…˜ ì ìˆ˜',
                        data: dataScores,
                        backgroundColor: bgColors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: -100, max: 100, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderIndividual(member) {
            if (!member || !member.birthdate) return;

            document.getElementById('ind-name-title').innerText = `${member.name}ë‹˜ì˜ ìš´ì„¸`;

            // 1. Static Info (Zodiac)
            const z1 = getZodiac(member.birthdate);
            const z2 = getChineseZodiac(member.birthdate);
            document.getElementById('zodiac-text').innerText = `${z1} / ${z2}`;

            // 2. Daily Keyword (Seeded by Name + Date)
            const dateStr = `${today.getFullYear()}${today.getMonth()}${today.getDate()}`;
            const seed = member.name + dateStr;
            const randVal = seededRandom(seed);

            const keyIdx = Math.floor(randVal * dailyKeywords.length);
            document.getElementById('daily-keyword').innerText = dailyKeywords[keyIdx];

            // 3. Fortune Cookie (Seeded by Name + Date + 'cookie')
            const cookieSeed = seed + 'cookie';
            const cookieRand = seededRandom(cookieSeed);
            const cookieIdx = Math.floor(cookieRand * fortuneCookies.length);

            document.getElementById('fortune-msg').innerText = `"${fortuneCookies[cookieIdx]}"`;

            // 4. Scratch Canvas Reset
            initScratchCanvas(member.name); // Reset scratch for this user

            // 5. Bio Chart
            if (chartInd) chartInd.destroy();

            const labels = [];
            const dP = [], dE = [], dI = [];
            const todayD = new Date();

            for (let i = -3; i <= 3; i++) {
                const d = new Date(todayD);
                d.setDate(todayD.getDate() + i);
                labels.push(`${d.getMonth() + 1}/${d.getDate()}`);

                const bio = getBiorhythm(member.birthdate, d);
                dP.push(bio.phys);
                dE.push(bio.emo);
                dI.push(bio.intel);
            }

            const ctx = document.getElementById('indChart').getContext('2d');
            chartInd = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ì‹ ì²´', data: dP, borderColor: '#22c55e', tension: 0.4, pointRadius: 3 },
                        { label: 'ê°ì„±', data: dE, borderColor: '#ef4444', tension: 0.4, pointRadius: 3 },
                        { label: 'ì§€ì„±', data: dI, borderColor: '#3b82f6', tension: 0.4, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: -100, max: 100, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Scratch Logic ---
        function initScratchCanvas(memberName) {
            // Need to check if user switched tab, scratch should be reset? 
            // Yes, user wants "scratch card" experience effectively per member view.

            const canvas = document.getElementById('scratchCanvas');
            const parent = document.getElementById('scratch-wrapper');
            const hint = document.getElementById('scratch-hint');

            if (!canvas || !parent) return;

            scratchCtx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = parent.offsetWidth;
            canvas.height = parent.offsetHeight;

            // Fill with gray/silver
            scratchCtx.globalCompositeOperation = 'source-over';
            scratchCtx.fillStyle = '#cccccc'; // silver
            scratchCtx.fillRect(0, 0, canvas.width, canvas.height);

            // Decoration text "Scratch Me"
            scratchCtx.fillStyle = '#999';
            scratchCtx.font = '20px sans-serif';
            scratchCtx.textAlign = 'center';
            scratchCtx.fillText("ğŸ€ ê¸ì–´ì„œ í–‰ìš´ í™•ì¸!", canvas.width / 2, canvas.height / 2);

            // Reset Drawing State
            isDrawing = false;
            hint.style.display = 'block'; // Show hint again

            // Event Listeners (ensure we don't duplicate if called multiple times)
            // It's safer to recreate or remove old listeners, but for simplicity here we assume simple switching.
            // Using 'on' properties to override previous handlers easily.

            canvas.onmousedown = startScratch;
            canvas.onmousemove = scratch;
            canvas.onmouseup = endScratch;
            canvas.onmouseleave = endScratch;

            // Touch support
            canvas.ontouchstart = (e) => { e.preventDefault(); startScratch(e.touches[0]); };
            canvas.ontouchmove = (e) => { e.preventDefault(); scratch(e.touches[0]); };
            canvas.ontouchend = endScratch;
        }

        function startScratch(e) {
            isDrawing = true;
            document.getElementById('scratch-hint').style.display = 'none'; // Hide hint once started
            scratch(e);
        }

        function scratch(e) {
            if (!isDrawing) return;

            const canvas = document.getElementById('scratchCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            scratchCtx.globalCompositeOperation = 'destination-out';
            scratchCtx.beginPath();
            scratchCtx.arc(x, y, 20, 0, Math.PI * 2); // Brush size
            scratchCtx.fill();
        }

        function endScratch() {
            isDrawing = false;
            // Check percent cleared? (Optional enhancement)
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            // Ideally resize canvas but that would clear it. Let's ignore for MVP.
        });

    </script>
</body>

</html>