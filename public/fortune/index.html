<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Garden - ?§Îäò???¥ÏÑ∏ & Î∞îÏù¥?§Î¶¨??/title>
    <link rel="stylesheet" href="../../assets/css/style.css?v=40">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192.png">
    <meta name="theme-color" content="#6366f1">

    <style>
        .fortune-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .fortune-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .zodiac-badge {
            background: var(--color-lemon);
            color: #d97706;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: #fff;
            color: #666;
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .bio-legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Scratch Card Styles */
        .scratch-wrapper {
            position: relative;
            width: 100%;
            height: 150px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            user-select: none;
            touch-action: none;
        }

        .fortune-cookie-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fffbf0, #fff);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 40px;
            text-align: center;
            font-size: 1.1rem;
            color: #333;
            font-weight: bold;
            line-height: 1.5;
            z-index: 1;
            overflow: hidden;
            box-sizing: border-box;
            /* Crucial Fix */
        }

        .fortune-cookie-content span {
            word-break: keep-all;
            max-width: 100%;
        }

        canvas#scratchCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            /* Cover content */
            cursor: pointer;
        }

        .scratch-hint {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            z-index: 3;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <a href="../dashboard.html" class="logo">??Secret Garden</a>
            <span>?¥ÏÑ∏ & Î∞îÏù¥?§Î¶¨??/span>
        </header>

        <div id="loading" class="p-4 text-center">?∞Ïù¥??Î°úÎî©Ï§?..</div>

        <!-- Main Content (Hidden until loaded) -->
        <div id="content" class="p-4 hidden">

            <div class="text-center" style="margin-bottom: 20px;">
                <h2 style="font-size: 1.3rem; color: var(--color-primary); margin-bottom: 5px;">
                    <span id="header-date"></span>???¥ÏÑ∏
                </h2>
                <p style="color: #666; font-size: 0.9rem;">?∞Î¶¨ Í∞ÄÏ°±Ïùò ?§Îäò Ïª®Îîî?òÏ??</p>
            </div>

            <!-- TAB Navigation -->
            <div class="tab-container" id="tab-nav">
                <button class="tab-btn active" onclick="switchTab('total')">?ìä Ï¢ÖÌï©</button>
            </div>

            <!-- 1. Total View Section -->
            <div id="section-total">
                <div class="fortune-card">
                    <h3 class="card-title">?ìà Í∞ÄÏ°?Ïª®Îîî????Çπ</h3>
                    <p style="font-size:0.8rem; color:#888; margin-bottom:15px;">?§Îäò???†Ï≤¥/Í∞êÏÑ±/ÏßÄ???âÍ∑† ?êÏàò?ÖÎãà??</p>
                    <div style="height: 250px;">
                        <canvas id="totalChart"></canvas>
                    </div>
                    <div class="text-center mt-3" id="total-comment" style="font-size:0.9rem; color:#333;">
                        Î∂ÑÏÑù Ï§?..
                    </div>
                </div>
            </div>

            <!-- 2. Individual View Section -->
            <div id="section-individual" class="hidden">
                <!-- Data for specific user -->
                <div class="fortune-card">
                    <div class="fortune-header">
                        <span class="card-title" style="margin:0;" id="ind-name-title">Î©§Î≤Ñ ?¥Î¶Ñ</span>
                        <span id="zodiac-text" class="zodiac-badge">Î≥ÑÏûêÎ¶?/ ??/span>
                    </div>

                    <!-- Western Horoscope (Galaxy Theme) -->
                    <div class="fortune-card western"
                        style="background: linear-gradient(135deg, #312e81 0%, #4338ca 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(49, 46, 129, 0.3);">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
                            <h4 style="margin:0; font-size:1.1rem; display:flex; align-items:center;">
                                <span style="margin-right:8px;">?åå</span> Î≥ÑÎì§???çÏÇ≠??
                            </h4>
                            <span id="western-sign"
                                style="font-size:0.85rem; background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:20px;"></span>
                        </div>
                        <div id="western-text"
                            style="line-height:1.7; font-size:0.95rem; opacity:0.95; margin-bottom:15px;">?¥ÏÑ∏ Î°úÎî© Ï§?..
                        </div>
                        <div id="western-badge" style="text-align:right;">
                            <span id="western-el-badge"
                                style="font-size:0.8rem; background:rgba(0,0,0,0.3); padding:4px 10px; border-radius:8px; color:#e0e7ff;"></span>
                        </div>
                    </div>

                    <!-- Eastern Fortune (Paper Theme) -->
                    <div class="fortune-card eastern"
                        style="background: #fffdf5; border: 1px solid #e7e5e4; padding: 20px; border-radius: 16px; margin-bottom: 24px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div
                            style="position:absolute; top:20px; right:20px; font-size:3rem; opacity:0.05; font-family:serif; pointer-events:none;">
                            ??/div>
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #e7e5e4; padding-bottom:10px;">
                            <h4 style="margin:0; font-size:1.1rem; color:#44403c; display:flex; align-items:center;">
                                <span style="margin-right:8px;">?ìú</span> ?†Î≥Ñ ?¥ÏÑ∏
                            </h4>
                            <span id="eastern-sign"
                                style="font-size:0.85rem; color:#57534e; background:#f5f5f4; padding:4px 12px; border-radius:20px; border:1px solid #d6d3d1;"></span>
                        </div>
                        <div id="eastern-text"
                            style="line-height:1.7; font-size:0.95rem; color:#292524; margin-bottom:15px;">?¥ÏÑ∏ Î°úÎî© Ï§?..
                        </div>
                        <div id="eastern-badge" style="text-align:right;">
                            <span id="eastern-el-badge"
                                style="font-size:0.8rem; background:#efebe9; padding:4px 10px; border-radius:8px; color:#5d4037;"></span>
                        </div>
                    </div>

                    <!-- Lucky Prescription (NEW) -->
                    <div class="fortune-card prescription"
                        style="background:#fff; border:2px dashed #e0e7ff; padding:20px; border-radius:16px; margin-bottom:24px; text-align:center;">
                        <h4 style="margin:0 0 15px 0; font-size:1.0rem; color:#4f46e5;">?? ?§Îäò???âÏö¥ Ï≤òÎ∞©??/h4>
                        <div style="display:flex; justify-content:space-around; flex-wrap:wrap; gap:10px;">
                            <div class="lucky-item">
                                <span id="lucky-color-chip"
                                    style="width:36px; height:36px; border-radius:50%; border:3px solid #e0e7ff; display:block; margin: 0 auto 5px auto; box-shadow: 0 2px 6px rgba(0,0,0,0.15);"></span>
                                <span style="font-size:0.8rem; color:#666;">?âÏÉÅ</span>
                                <span id="lucky-color"
                                    style="font-weight:bold; color:#333; font-size:0.85rem; display:block; margin-top:3px;">-</span>
                            </div>
                            <div class="lucky-item">
                                <span style="font-size:1.5rem; display:block; margin-bottom:5px;">?íç</span>
                                <span style="font-size:0.8rem; color:#666;">?ÑÏù¥??/span>
                                <div id="lucky-item" style="font-weight:bold; color:#333; font-size:0.9rem;">-</div>
                            </div>
                            <div class="lucky-item">
                                <span style="font-size:1.5rem; display:block; margin-bottom:5px;">?ß≠</span>
                                <span style="font-size:0.8rem; color:#666;">Î∞©Ìñ•</span>
                                <div id="lucky-dir" style="font-weight:bold; color:#333; font-size:0.9rem;">-</div>
                            </div>
                            <div class="lucky-item">
                                <span style="font-size:1.5rem; display:block; margin-bottom:5px;">?î¢</span>
                                <span style="font-size:0.8rem; color:#666;">?´Ïûê</span>
                                <div id="lucky-num" style="font-weight:bold; color:#333; font-size:0.9rem;">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Biorhythm Card (Separated) -->
                    <div class="fortune-card">
                        <h3 class="card-title">?ß¨ Î∞îÏù¥?§Î¶¨??/h3>
                        <div style="height: 200px; position: relative;">
                            <canvas id="indChart"></canvas>
                        </div>
                        <div class="bio-legend">
                            <div class="legend-item"><span class="dot" style="background:#22c55e"></span>?†Ï≤¥</div>
                            <div class="legend-item"><span class="dot" style="background:#ef4444"></span>Í∞êÏÑ±</div>
                            <div class="legend-item"><span class="dot" style="background:#3b82f6"></span>ÏßÄ??/div>
                        </div>
                    </div>
                </div>

                <!-- Individual Scratch Card -->
                <div class="fortune-card" style="background: linear-gradient(135deg, #fff, #fdfbf7);">
                    <h3 class="card-title" style="text-align: center;">?•† ?§Îäò???¨Ï∂ò Ïø†ÌÇ§ (Í∏ÅÏñ¥Î≥¥ÏÑ∏??)</h3>

                    <div class="scratch-wrapper" id="scratch-wrapper">
                        <div class="fortune-cookie-content">
                            <span id="fortune-msg">?âÏö¥??Î©îÏãúÏßÄÎ•??ïÏù∏?òÏÑ∏??/span>
                        </div>
                        <canvas id="scratchCanvas"></canvas>
                        <div class="scratch-hint" id="scratch-hint">?ëÜ ?•Ïä• Í∏ÅÏñ¥Î≥¥ÏÑ∏??</div>
                    </div>
                </div>
            </div>

            <!-- Shared Scratch Card Message for Total Tab (Hidden in Individual) -->
            <div id="total-scratch-section" class="fortune-card"
                style="background: linear-gradient(135deg, #fff, #fdfbf7);">
                <p style="text-align: center; color:#888;">?ëÜ <strong>Í∞úÏù∏Î≥???/strong>?êÏÑú Í∞ÅÏûê???¥ÏÑ∏?Ä ?¨Ï∂ò Ïø†ÌÇ§Î•??ïÏù∏?¥Î≥¥?∏Ïöî!</p>
            </div>

        </div>
    </div>

    <script type="module">
        import { auth, db } from '../../src/firebase.js?v=40';
        import { getZodiac, getChineseZodiac, familyData } from '../../src/users.js?v=40';
        import { getDailyHoroscope, getDailyOrientalFortune, getLuckyPrescription } from '../../src/fortune_engine.js?v=40';

        // Expanded Data
        const fortuneCookies = [
            // ?? ÎßàÏùå (?†Ï?) - Existing Cookie Data preserved for scratch card
            "5Î∂ÑÎßå ?¨Ïñ¥???òÎ£®Í∞Ä ?¨ÎùºÏßëÎãà?? ÏßÑÏßú?àÏöî.",
            "?§Îäò Í∏∞Î∂Ñ??ÏßëÏïà Î∂ÑÏúÑÍ∏∞Î? ÎßåÎì≠?àÎã§. ?πÏã†???úÏñë?¥Ïóê??",
            "Í±±Ï†ï?Ä ?µÍ???Îø? ?§Îäò?Ä Ï¢ãÏ? ?ÅÏÉÅ???¥Î≥¥?∏Ïöî.",
            "Í∞êÏÇ¨??ÎßàÏùå ?òÎÇòÎ©??òÎ£®Í∞Ä ?∞Îúª?¥Ïßë?àÎã§.",
            "?πÏã† ÎØ∏ÏÜå ?òÎÇòÎ°???ÏßëÏïà???òÌï¥ÏßëÎãà??",
            "Ï≤úÏ≤ú??Í∞Ä??Í¥úÏ∞Æ?ÑÏöî. Î©àÏ∂îÏßÄÎß??äÏúºÎ©??©Îãà??",
            "ÎßàÏùå??ÎπÑÏö∞Î©?Ï¢ãÏ? ???§Ïñ¥???êÎ¶¨Í∞Ä ?ùÍπÅ?àÎã§.",
            "Ï°∞Ïö©???âÏö¥??ÏßÄÍ∏?Î¨??ûÍπåÏßÄ ?Ä ?àÏäµ?àÎã§.",

            // ?ë™ Í∞ÄÏ°?(?†Ï?)
            "Í∞ÄÏ°??®ÌÜ°???òÌä∏ ?òÎÇò, Í∑∏Í≤ÉÎßåÏúºÎ°úÎèÑ Ï∂©Î∂Ñ?©Îãà??",
            "Í∞ôÏù¥ ?ÉÏúºÎ©?Í∑∏Í≤å Î∞îÎ°ú Î≥µÏûÖ?àÎã§.",
            "?∞Îúª??Îß??úÎßà?îÍ? ?òÎ£®Î•?Î∞îÍøâ?àÎã§.",
            "Î®ºÏ? ?∞ÎùΩ?òÎ©¥ ?ÅÎ???Í∏∞Îã§Î¶¨Í≥† ?àÏóà??Í±∞Ïòà??",
            "?ëÏ? Î∞∞Î†§ ?òÎÇòÍ∞Ä Í¥ÄÍ≥ÑÎ? ???®Îã®?òÍ≤å ÎßåÎì≠?àÎã§.",
            "?§Îûò??ÏπúÍµ¨?êÍ≤å ?àÎ? ?úÎßà?? ?úÎ°ú?êÍ≤å Ï¢ãÏ? ?†Ïù¥ ?©Îãà??",
            "Ï°∞Í∏àÎß??ÅÎ? ?ÖÏû•?êÏÑú ?ùÍ∞Å?òÎ©¥ ?ÄÎ∂ÄÎ∂??ÄÎ¶ΩÎãà??",
            "ÏßÑÏã¨?Ä ??ñ¥??Î∞òÎìú???ÑÌï¥ÏßëÎãà??",

            // ?? ?ÑÏ†Ñ (?†Ï?)
            "?§Îäò ?úÏûë?òÎ©¥ ?¥Ïùº???∏Ìï¥ÏßëÎãà??",
            "ÏßÄÍ∏??∏Î†•?Ä ?òÏ§ë???¥Ïûê Î∂ôÏñ¥???åÏïÑ?µÎãà??",
            "??Í±∏ÏùåÎß??ºÎ©¥ ?ùÍ∞ÅÎ≥¥Îã§ ?ΩÍ≤å ?ÄÎ¶ΩÎãà??",
            "Ï§ÄÎπÑÎêú ?¨Îûå?êÍ≤å Í∏∞Ìöå??Íº?Ï∞æÏïÑ?µÎãà??",
            "?ëÍ≤å ?úÏûë?¥ÎèÑ Í¥úÏ∞Æ?ÑÏöî. ?úÏûë??Î∞òÏûÖ?àÎã§.",
            "?©Í∏∞ ?¥Î©¥ Ï¢ãÏ? Í≤∞Í≥ºÍ∞Ä ?∞Îùº?µÎãà??",
            "ÏßÄÍ∏??±Ïã§?®Ïù¥ ?òÏ§ë???†Îì†???òÏù¥ ?©Îãà??",
            "?ùÍ∞ÅÎ≥¥Îã§ ?®Ïî¨ ?òÌïòÍ≥??àÏñ¥?? ?êÏã†Í∞?Í∞ÄÏßÄ?∏Ïöî.",

            // ?å± ?±Ïû• (?†Ï?)
            "?§Ïàò??Î∞∞Ïö∞??Í≥ºÏ†ï?ÖÎãà?? Í¥úÏ∞Æ?ÑÏöî.",
            "?§Îäò ?†ÌÉù???¥Ïùº??ÎßåÎì≠?àÎã§. ?†Ï§ë?òÎêò Î∂Ä??Í∞ñÏ? ÎßàÏÑ∏??",
            "Î∞∞Ïö∞?§Îäî ?êÏÑ∏Î©?Ï∂©Î∂Ñ?©Îãà??",
            "?àÎ°ú???úÎèÑ???àÎ°ú??Í∞Ä?•ÏÑ±?ÖÎãà??",
            "Î≥Ä?îÎäî Î¨¥ÏÑ≠ÏßÄÎß??±Ïû•??Í∏∞Ìöå?ÖÎãà??",
            "Ï°∞Í∏àÎß??§Î•¥Í≤?Î≥¥Î©¥ ?µÏù¥ Î≥¥ÏûÖ?àÎã§.",
            "?§Îäò Î∞∞Ïö¥ Í≤ÉÏù¥ ?¥Ïùº ?òÏù¥ ?©Îãà??",
            "Íæ∏Ï??®Ïù¥ ?¨Îä•???¥ÍπÅ?àÎã§.",

            // ?åû ?âÏö¥ (?†Ï?)
            "?§Îäò Ï¢ãÏ? ???òÎÇò ?ùÍ∏∏ Í±∞Ïòà??",
            "?âÎ≤î???§Îäò???πÎ≥Ñ?¥Ï????†ÏûÖ?àÎã§.",
            "Ï¢ãÏ? ?åÏãù???§Í≥† ?àÏäµ?àÎã§.",
            "?àÏÉÅÏπ?Î™ªÌïú Í≥≥Ïóê???ÑÏ????µÎãà??",
            "?§Îäò?Ä Î™®Îì† ?ºÏù¥ ???ÄÎ¶?Í±∞Ïòà??",
            "?ëÏ? ?†ÌÉù?????âÏö¥???????àÏäµ?àÎã§.",
            "?¥Î? ÎßéÏ? ?âÏö¥???®Íªò?òÍ≥† ?àÏäµ?àÎã§.",
            "Ï°∞Ïö©???âÎ≥µ???òÎ£® Ï¢ÖÏùº ?®Íªò??Í±∞Ïòà??"
        ];

        let membersData = [];
        let chartTotal = null;
        let chartInd = null;
        let scratchCanvas = null;
        let scratchCtx = null;
        let isDrawing = false;
        let currentScratchMember = null;

        // Init
        const today = new Date();
        document.getElementById('header-date').innerText = `${today.getMonth() + 1}??${today.getDate()}??;

        auth.onAuthStateChanged(user => {
            if (!user) {
                location.href = '../login.html';
            } else {
                loadFamilyData(user);
            }
        });

        // Simple seeded random function
        function seededRandom(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            const x = Math.sin(hash) * 10000;
            return x - Math.floor(x);
        }

        async function loadFamilyData(user) {
            try {
                const names = Object.keys(familyData); membersData = names.map(name => ({
                    name: name,
                    birthdate: familyData[name].birthdate
                }));

                renderTabs();
                renderTotalChart();

                // [NEW] Auto-select tab for logged-in user
                const storedName = sessionStorage.getItem('user_name');
                if (storedName) {
                    const myIdx = membersData.findIndex(m => m.name === storedName);
                    if (myIdx !== -1) {
                        switchTab(myIdx);
                    }
                }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                alert("?∞Ïù¥??Î°úÎî© ?§Ìå®");
            }
        }

        function renderTabs() {
            const container = document.getElementById('tab-nav');
            // Reset tabs (keep first one "Total")
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            membersData.forEach((m, idx) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = m.name;
                btn.onclick = (e) => switchTab(idx, e);
                container.appendChild(btn);
            });
        }

        window.switchTab = function (tabId, event) {
            // UI Toggle
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(b => b.classList.remove('active'));

            if (event) {
                event.target.classList.add('active');
            } else {
                // Fallback or Initial
            }

            if (tabId === 'total') {
                document.getElementById('section-total').classList.remove('hidden');
                document.getElementById('section-individual').classList.add('hidden');
                document.getElementById('total-scratch-section').classList.remove('hidden'); // Show Guide
                renderTotalChart();
            } else {
                document.getElementById('section-total').classList.add('hidden');
                document.getElementById('section-individual').classList.remove('hidden');
                document.getElementById('total-scratch-section').classList.add('hidden'); // Hide Guide
                renderIndividual(membersData[tabId]);
            }
        }

        function getBiorhythm(birthStr, targetDate) {
            const birth = new Date(birthStr);
            const diffTime = targetDate - birth;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            const phys = Math.sin(2 * Math.PI * diffDays / 23) * 100;
            const emo = Math.sin(2 * Math.PI * diffDays / 28) * 100;
            const intel = Math.sin(2 * Math.PI * diffDays / 33) * 100;

            return { phys, emo, intel, avg: (phys + emo + intel) / 3 };
        }

        function renderTotalChart() {
            if (chartTotal) chartTotal.destroy();

            const labels = [];
            const dataScores = [];
            const bgColors = [];

            membersData.forEach(m => {
                if (!m.birthdate) return;
                const bio = getBiorhythm(m.birthdate, new Date());
                labels.push(m.name);
                dataScores.push(bio.avg);

                if (bio.avg > 50) bgColors.push('#22c55e');
                else if (bio.avg > 0) bgColors.push('#fbbf24');
                else bgColors.push('#ef4444');
            });

            let maxScore = -100;
            let bestMember = "";
            dataScores.forEach((s, i) => {
                if (s > maxScore) { maxScore = s; bestMember = labels[i]; }
            });

            document.getElementById('total-comment').innerText =
                `?§Îäò Ïª®Îîî???ïÏ? ?ëë ${bestMember}?? (${Math.round(maxScore)}??`;

            const ctx = document.getElementById('totalChart').getContext('2d');
            chartTotal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ï¢ÖÌï© Ïª®Îîî???êÏàò',
                        data: dataScores,
                        backgroundColor: bgColors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: -100, max: 100, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderIndividual(member) {
            if (!member || !member.birthdate) return;

            document.getElementById('ind-name-title').innerText = `${member.name}?òÏùò ?¥ÏÑ∏`;

            // 1. Static Info (Zodiac)
            const z1 = getZodiac(member.birthdate);
            const z2 = getChineseZodiac(member.birthdate);
            document.getElementById('zodiac-text').innerText = `${member.birthdate} (${z1}/${z2})`;

            // 2. Fortune Engine 2.0 (Dual Display)

            // A. Western Horoscope
            const horo = getDailyHoroscope(member.name, member.birthdate);
            if (horo) {
                document.getElementById('western-sign').innerText = horo.sign;
                document.getElementById('western-text').innerHTML = formatFortuneText(horo.text);

                // Element Badge Map
                const wMap = { fire: "?î• Î∂àÏùò ?êÏÜå (Fire Element)", earth: "?∞Ô∏è ?ôÏùò ?êÏÜå (Earth Element)", air: "?í® Í≥µÍ∏∞???êÏÜå (Air Element)", water: "?íß Î¨ºÏùò ?êÏÜå (Water Element)" };
                document.getElementById('western-el-badge').innerText = wMap[horo.element] || horo.element;
            }

            // B. Oriental Fortune
            const oriental = getDailyOrientalFortune(member.name, member.birthdate);
            if (oriental) {
                document.getElementById('eastern-sign').innerText = oriental.sign;
                document.getElementById('eastern-text').innerHTML = formatFortuneText(oriental.text);

                // Element Badge Map
                const eMap = {
                    wood: "?å≤ Î™??òÎ¨¥)???êÎ¶Ñ",
                    fire: "?î• ??Î∂????êÎ¶Ñ",
                    earth: "?∞Ô∏è ???????êÎ¶Ñ",
                    metal: "?îÔ∏è Í∏??????êÎ¶Ñ",
                    water: "?åä ??Î¨????êÎ¶Ñ"
                };
                document.getElementById('eastern-el-badge').innerText = eMap[oriental.element] || oriental.element;
            }

            function formatFortuneText(text) {
                if (!text) return "";
                // Highlight bold parts **text** -> <b>text</b>
                return text.replace(/\*\*(.*?)\*\*/g, '<b style="color:inherit; opacity:1;">$1</b>');
            }

            // C. Lucky Prescription (NEW)
            const lucky = getLuckyPrescription(member.name, member.birthdate);
            if (lucky) {
                document.getElementById('lucky-color').innerText = lucky.color;

                // Color chip mapping
                const colorMap = {
                    "Î°úÏó¥ Î∏îÎ£®": "#4169E1", "?¨Î†à?§Ìä∏ Í∑∏Î¶∞": "#228B22", "?¨Î¶º Î≤†Ïù¥ÏßÄ": "#F5F5DC",
                    "ÎØ∏Îìú?òÏûá Î∏îÎûô": "#191970", "Î≤ÑÍ±¥???àÎìú": "#800020", "Î®∏Ïä§?Ä???êÎ°ú??: "#FFDB58",
                    "?®Ïñ¥ ?îÏù¥??: "#FFFFFF", "Ï∞®ÏΩú Í∑∏Î†à??: "#36454F", "?ºÎ≤§???ºÌîå": "#E6E6FA",
                    "?§Ïπ¥??Î∏îÎ£®": "#87CEEB", "ÏΩîÎûÑ ?ëÌÅ¨": "#FF7F7F", "ÎØºÌä∏ Í∑∏Î¶∞": "#98FF98",
                    "?¨Î¶¨Î∏?Ïπ¥ÌÇ§": "#6B8E23", "?§Ïù¥Îπ?: "#000080", "Ï¥àÏΩúÎ¶?Î∏åÎùº??: "#7B3F00",
                    "?¥Ìéò??Í≥®Îìú": "#F7E7CE", "?§Î≤Ñ": "#C0C0C0", "Î°úÏ¶à Í≥®Îìú": "#B76E79",
                    "?∞ÏΩî?¥Ï¶à": "#40E0D0", "?∏ÎîîÍ≥?: "#4B0082", "Î∞îÏù¥?¨Î†õ": "#EE82EE",
                    "ÎßàÏ††?Ä": "#FF00FF", "?¥Î™¨": "#FA8072", "?åÎùºÏΩîÌ?": "#E2725B",
                    "?ÑÏù¥Î≥¥Î¶¨": "#FFFFF0", "?åÎìú Î≤†Ïù¥ÏßÄ": "#F5DEB3", "Î™®Ïπ¥": "#967969",
                    "?¨Î†à?¥Ìä∏ Î∏îÎ£®": "#6A5ACD", "??Í∑∏Î¶∞": "#008080", "?ºÏπò": "#FFCBA4",
                    "?àÎ™¨ ?êÎ°ú??: "#FFF44F", "?†Ïâ¨ Í∑∏Î†à??: "#B2BEB5", "?§ÏÖò Î∏îÎ£®": "#0096FF",
                    "?†ÏÖã ?§Î†åÏßÄ": "#FF4500", "?ºÏûÑ": "#00FF00", "?ºÏãú??Î∏îÎ£®": "#1CA9C9",
                    "??Í∑∏Î¶∞": "#006400", "???îÏù¥??: "#F0EAD6", "Îß§Ìä∏ Î∏îÎûô": "#28282B",
                    "Î∏åÎ°†Ï¶?: "#CD7F32", "Ïπ¥Î©ú": "#C19A6B", "?Ä??: "#722F37",
                    "???ºÌîå": "#301934", "?åÏä§???ëÌÅ¨": "#FFD1DC", "?ºÎ†â?∏Î¶≠ Î∏îÎ£®": "#7DF9FF",
                    "?§Ïò® ?¨Ïù∏": "#FF6EC7", "?åÌîÑ???ëÌÅ¨": "#FADADD", "??Í∑∏Î†à??: "#808069",
                    "Ïø?Í∑∏Î†à??: "#8C92AC", "ÎπÑÎπÑ???àÎìú": "#FF0000", "Î∏îÎûô & ?îÏù¥??: "linear-gradient(135deg, #000 50%, #fff 50%)"
                };
                const colorChip = document.getElementById('lucky-color-chip');
                const mappedColor = colorMap[lucky.color] || "#cccccc";
                if (mappedColor.startsWith('linear')) {
                    colorChip.style.background = mappedColor;
                } else {
                    colorChip.style.backgroundColor = mappedColor;
                }

                document.getElementById('lucky-item').innerText = lucky.item;
                document.getElementById('lucky-dir').innerText = lucky.direction;
                document.getElementById('lucky-num').innerText = lucky.number;
            }

            // 3. Fortune Cookie (Seeded by Name + Date + 'cookie')
            const dateStr = `${today.getFullYear()}${today.getMonth()}${today.getDate()}`;
            const seed = member.name + dateStr;
            const cookieSeed = seed + 'cookie';
            const cookieRand = seededRandom(cookieSeed);
            const cookieIdx = Math.floor(cookieRand * fortuneCookies.length);

            document.getElementById('fortune-msg').innerText = `"${fortuneCookies[cookieIdx]}"`;

            // 4. Scratch Canvas Reset
            // [FIX] Add delay to ensure DOM is visible and has dimensions before init
            setTimeout(() => {
                initScratchCanvas(member.name);
            }, 100);

            // 5. Bio Chart
            if (chartInd) chartInd.destroy();

            const labels = [];
            const dP = [], dE = [], dI = [];
            const todayD = new Date();

            for (let i = -3; i <= 3; i++) {
                const d = new Date(todayD);
                d.setDate(todayD.getDate() + i);
                labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
                const bio = getBiorhythm(member.birthdate, d);
                dP.push(bio.phys);
                dE.push(bio.emo);
                dI.push(bio.intel);
            }

            const ctx = document.getElementById('indChart').getContext('2d');
            chartInd = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '?†Ï≤¥', data: dP, borderColor: '#22c55e', tension: 0.4, pointRadius: 3
                    }, { label: 'Í∞êÏÑ±', data: dE, borderColor: '#ef4444', tension: 0.4, pointRadius: 3 }, {
                        label: 'ÏßÄ??, data:
                            dI, borderColor: '#3b82f6', tension: 0.4, pointRadius: 3
                    }]
                }, options: {
                    responsive: true,
                    maintainAspectRatio: false, scales: {
                        y: { min: -100, max: 100, grid: { color: '#f0f0f0' } }, x: {
                            grid: {
                                display: false
                            }
                        }
                    }, plugins: { legend: { display: false } }
                }
            });
        }

        // --- Scratch Logic ---
        function initScratchCanvas(memberName) {
            const canvas = document.getElementById('scratchCanvas');
            const parent = document.getElementById('scratch-wrapper');
            const hint = document.getElementById('scratch-hint');

            if (!canvas || !parent) return;

            scratchCtx = canvas.getContext('2d');
            canvas.width = parent.offsetWidth;
            canvas.height = parent.offsetHeight;

            // Fill with gray/silver
            scratchCtx.globalCompositeOperation = 'source-over';
            scratchCtx.fillStyle = '#cccccc';
            scratchCtx.fillRect(0, 0, canvas.width, canvas.height);

            // Decoration text "Scratch Me"
            scratchCtx.fillStyle = '#999';
            scratchCtx.font = '20px sans-serif';
            scratchCtx.textAlign = 'center';
            scratchCtx.fillText("?? Í∏ÅÏñ¥???âÏö¥ ?ïÏù∏!", canvas.width / 2, canvas.height / 2);

            // Reset Drawing State
            isDrawing = false;
            hint.style.display = 'block';

            // Event Listeners
            canvas.onmousedown = startScratch;
            canvas.onmousemove = scratch;
            canvas.onmouseup = endScratch;
            canvas.onmouseleave = endScratch;

            // Touch support
            canvas.ontouchstart = (e) => { e.preventDefault(); startScratch(e.touches[0]); };
            canvas.ontouchmove = (e) => { e.preventDefault(); scratch(e.touches[0]); };
            canvas.ontouchend = endScratch;
        }

        function startScratch(e) {
            isDrawing = true;
            document.getElementById('scratch-hint').style.display = 'none'; // Hide hint once started
            scratch(e);
        }

        function scratch(e) {
            if (!isDrawing) return;

            const canvas = document.getElementById('scratchCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            scratchCtx.globalCompositeOperation = 'destination-out';
            scratchCtx.beginPath();
            scratchCtx.arc(x, y, 20, 0, Math.PI * 2); // Brush size
            scratchCtx.fill();
        }

        function endScratch() {
            isDrawing = false;
            // Check percent cleared? (Optional enhancement)
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            // Ideally resize canvas but that would clear it. Let's ignore for MVP.
        });

    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../sw.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>
</body>

</html>
