<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Garden - ì˜¤ëŠ˜ì˜ ìš´ì„¸ & ë°”ì´ì˜¤ë¦¬ë“¬</title>
    <link rel="stylesheet" href="../../assets/css/style.css?v=15">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192.png">
    <meta name="theme-color" content="#6366f1">

    <style>
        .fortune-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .fortune-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .zodiac-badge {
            background: var(--color-lemon);
            color: #d97706;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: #fff;
            color: #666;
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .bio-legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Scratch Card Styles */
        .scratch-wrapper {
            position: relative;
            width: 100%;
            height: 150px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            user-select: none;
            touch-action: none;
        }

        .fortune-cookie-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fffbf0, #fff);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 40px;
            text-align: center;
            font-size: 1.1rem;
            color: #333;
            font-weight: bold;
            line-height: 1.5;
            z-index: 1;
            overflow: hidden;
            box-sizing: border-box;
            /* Crucial Fix */
        }

        .fortune-cookie-content span {
            word-break: keep-all;
            max-width: 100%;
        }

        canvas#scratchCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            /* Cover content */
            cursor: pointer;
        }

        .scratch-hint {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            z-index: 3;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <a href="../dashboard.html" class="logo">â† Secret Garden</a>
            <span>ìš´ì„¸ & ë°”ì´ì˜¤ë¦¬ë“¬</span>
        </header>

        <div id="loading" class="p-4 text-center">ë°ì´í„° ë¡œë”©ì¤‘...</div>

        <!-- Main Content (Hidden until loaded) -->
        <div id="content" class="p-4 hidden">

            <div class="text-center" style="margin-bottom: 20px;">
                <h2 style="font-size: 1.3rem; color: var(--color-primary); margin-bottom: 5px;">
                    <span id="header-date"></span>ì˜ ìš´ì„¸
                </h2>
                <p style="color: #666; font-size: 0.9rem;">ìš°ë¦¬ ê°€ì¡±ì˜ ì˜¤ëŠ˜ ì»¨ë””ì…˜ì€?</p>
            </div>

            <!-- TAB Navigation -->
            <div class="tab-container" id="tab-nav">
                <button class="tab-btn active" onclick="switchTab('total')">ğŸ“Š ê°€ì¡± ì¢…í•©</button>
            </div>

            <!-- 1. Total View Section -->
            <div id="section-total">
                <div class="fortune-card">
                    <h3 class="card-title">ğŸ“ˆ ê°€ì¡± ì»¨ë””ì…˜ ë­í‚¹</h3>
                    <p style="font-size:0.8rem; color:#888; margin-bottom:15px;">ì˜¤ëŠ˜ì˜ ì‹ ì²´/ê°ì„±/ì§€ì„± í‰ê·  ì ìˆ˜ì…ë‹ˆë‹¤.</p>
                    <div style="height: 250px;">
                        <canvas id="totalChart"></canvas>
                    </div>
                    <div class="text-center mt-3" id="total-comment" style="font-size:0.9rem; color:#333;">
                        ë¶„ì„ ì¤‘...
                    </div>
                </div>
            </div>

            <!-- 2. Individual View Section -->
            <div id="section-individual" class="hidden">
                <!-- Data for specific user -->
                <div class="fortune-card">
                    <div class="fortune-header">
                        <span class="card-title" style="margin:0;" id="ind-name-title">ë©¤ë²„ ì´ë¦„</span>
                        <span id="zodiac-text" class="zodiac-badge">ë³„ìë¦¬ / ë </span>
                    </div>

                    <!-- Western Horoscope (Galaxy Theme) -->
                    <div class="fortune-card western"
                        style="background: linear-gradient(135deg, #312e81 0%, #4338ca 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(49, 46, 129, 0.3);">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
                            <h4 style="margin:0; font-size:1.1rem; display:flex; align-items:center;">
                                <span style="margin-right:8px;">ğŸŒŒ</span> ë³„ë“¤ì˜ ì†ì‚­ì„
                            </h4>
                            <span id="western-sign"
                                style="font-size:0.85rem; background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:20px;"></span>
                        </div>
                        <div id="western-text"
                            style="line-height:1.7; font-size:0.95rem; opacity:0.95; margin-bottom:15px;">ìš´ì„¸ ë¡œë”© ì¤‘...
                        </div>
                        <div id="western-badge" style="text-align:right;">
                            <span id="western-el-badge"
                                style="font-size:0.8rem; background:rgba(0,0,0,0.3); padding:4px 10px; border-radius:8px; color:#e0e7ff;"></span>
                        </div>
                    </div>

                    <!-- Eastern Fortune (Paper Theme) -->
                    <div class="fortune-card eastern"
                        style="background: #fffdf5; border: 1px solid #e7e5e4; padding: 20px; border-radius: 16px; margin-bottom: 24px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div
                            style="position:absolute; top:20px; right:20px; font-size:3rem; opacity:0.05; font-family:serif; pointer-events:none;">
                            é‹</div>
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #e7e5e4; padding-bottom:10px;">
                            <h4 style="margin:0; font-size:1.1rem; color:#44403c; display:flex; align-items:center;">
                                <span style="margin-right:8px;">ğŸ“œ</span> ì˜¤ëŠ˜ì˜ ë ë³„ ìš´ì„¸
                            </h4>
                            <span id="eastern-sign"
                                style="font-size:0.85rem; color:#57534e; background:#f5f5f4; padding:4px 12px; border-radius:20px; border:1px solid #d6d3d1;"></span>
                        </div>
                        <div id="eastern-text"
                            style="line-height:1.7; font-size:0.95rem; color:#292524; margin-bottom:15px;">ìš´ì„¸ ë¡œë”© ì¤‘...
                        </div>
                        <div id="eastern-badge" style="text-align:right;">
                            <span id="eastern-el-badge"
                                style="font-size:0.8rem; background:#efebe9; padding:4px 10px; border-radius:8px; color:#5d4037;"></span>
                        </div>
                    </div>

                    <h3 class="card-title">ğŸ§¬ ë°”ì´ì˜¤ë¦¬ë“¬ ìƒì„¸</h3>
                    <div style="height: 200px; position: relative;">
                        <canvas id="indChart"></canvas>
                    </div>
                    <div class="bio-legend">
                        <div class="legend-item"><span class="dot" style="background:#22c55e"></span>ì‹ ì²´</div>
                        <div class="legend-item"><span class="dot" style="background:#ef4444"></span>ê°ì„±</div>
                        <div class="legend-item"><span class="dot" style="background:#3b82f6"></span>ì§€ì„±</div>
                    </div>
                </div>

                <!-- Individual Scratch Card -->
                <div class="fortune-card" style="background: linear-gradient(135deg, #fff, #fdfbf7);">
                    <h3 class="card-title" style="text-align: center;">ğŸ¥  ì˜¤ëŠ˜ì˜ í¬ì¶˜ ì¿ í‚¤ (ê¸ì–´ë³´ì„¸ìš”!)</h3>

                    <div class="scratch-wrapper" id="scratch-wrapper">
                        <div class="fortune-cookie-content">
                            <span id="fortune-msg">í–‰ìš´ì˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”</span>
                        </div>
                        <canvas id="scratchCanvas"></canvas>
                        <div class="scratch-hint" id="scratch-hint">ğŸ‘† ìŠ¥ìŠ¥ ê¸ì–´ë³´ì„¸ìš”!</div>
                    </div>
                </div>
            </div>

            <!-- Shared Scratch Card Message for Total Tab (Hidden in Individual) -->
            <div id="total-scratch-section" class="fortune-card"
                style="background: linear-gradient(135deg, #fff, #fdfbf7);">
                <p style="text-align: center; color:#888;">ğŸ‘† <strong>ê°œì¸ë³„ íƒ­</strong>ì—ì„œ ê°ìì˜ í¬ì¶˜ ì¿ í‚¤ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>
            </div>

        </div>
    </div>

    <script type="module">
        import { auth, db } from '../../src/firebase.js?v=7';
        import { getZodiac, getChineseZodiac, familyData } from '../../src/users.js?v=6';
        import { getDailyHoroscope, getDailyOrientalFortune } from '../../src/fortune_engine.js?v=2';

        // Expanded Data 
        const fortuneCookies = [
            // ğŸ€ ë§ˆìŒ (ìœ ì§€) - Existing Cookie Data preserved for scratch card
            "5ë¶„ë§Œ ì‰¬ì–´ë„ í•˜ë£¨ê°€ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ì§„ì§œì˜ˆìš”.",
            "ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì§‘ì•ˆ ë¶„ìœ„ê¸°ë¥¼ ë§Œë“­ë‹ˆë‹¤. ë‹¹ì‹ ì´ íƒœì–‘ì´ì—ìš”.",
            "ê±±ì •ì€ ìŠµê´€ì¼ ë¿. ì˜¤ëŠ˜ì€ ì¢‹ì€ ìƒìƒì„ í•´ë³´ì„¸ìš”.",
            "ê°ì‚¬í•œ ë§ˆìŒ í•˜ë‚˜ë©´ í•˜ë£¨ê°€ ë”°ëœ»í•´ì§‘ë‹ˆë‹¤.",
            "ë‹¹ì‹  ë¯¸ì†Œ í•˜ë‚˜ë¡œ ì˜¨ ì§‘ì•ˆì´ í™˜í•´ì§‘ë‹ˆë‹¤.",
            "ì²œì²œíˆ ê°€ë„ ê´œì°®ì•„ìš”. ë©ˆì¶”ì§€ë§Œ ì•Šìœ¼ë©´ ë©ë‹ˆë‹¤.",
            "ë§ˆìŒì„ ë¹„ìš°ë©´ ì¢‹ì€ ì¼ ë“¤ì–´ì˜¬ ìë¦¬ê°€ ìƒê¹ë‹ˆë‹¤.",
            "ì¡°ìš©í•œ í–‰ìš´ì´ ì§€ê¸ˆ ë¬¸ ì•ê¹Œì§€ ì™€ ìˆìŠµë‹ˆë‹¤.",

            // ğŸ‘ª ê°€ì¡± (ìœ ì§€)
            "ê°€ì¡± ë‹¨í†¡ì— í•˜íŠ¸ í•˜ë‚˜, ê·¸ê²ƒë§Œìœ¼ë¡œë„ ì¶©ë¶„í•©ë‹ˆë‹¤.",
            "ê°™ì´ ì›ƒìœ¼ë©´ ê·¸ê²Œ ë°”ë¡œ ë³µì…ë‹ˆë‹¤.",
            "ë”°ëœ»í•œ ë§ í•œë§ˆë””ê°€ í•˜ë£¨ë¥¼ ë°”ê¿‰ë‹ˆë‹¤.",
            "ë¨¼ì € ì—°ë½í•˜ë©´ ìƒëŒ€ë„ ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆì„ ê±°ì˜ˆìš”.",
            "ì‘ì€ ë°°ë ¤ í•˜ë‚˜ê°€ ê´€ê³„ë¥¼ ë” ë‹¨ë‹¨í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.",
            "ì˜¤ë˜ëœ ì¹œêµ¬ì—ê²Œ ì•ˆë¶€ í•œë§ˆë””, ì„œë¡œì—ê²Œ ì¢‹ì€ ë‚ ì´ ë©ë‹ˆë‹¤.",
            "ì¡°ê¸ˆë§Œ ìƒëŒ€ ì…ì¥ì—ì„œ ìƒê°í•˜ë©´ ëŒ€ë¶€ë¶„ í’€ë¦½ë‹ˆë‹¤.",
            "ì§„ì‹¬ì€ ëŠ¦ì–´ë„ ë°˜ë“œì‹œ ì „í•´ì§‘ë‹ˆë‹¤.",

            // ğŸš€ ë„ì „ (ìœ ì§€)
            "ì˜¤ëŠ˜ ì‹œì‘í•˜ë©´ ë‚´ì¼ì´ í¸í•´ì§‘ë‹ˆë‹¤.",
            "ì§€ê¸ˆ ë…¸ë ¥ì€ ë‚˜ì¤‘ì— ì´ì ë¶™ì–´ì„œ ëŒì•„ì˜µë‹ˆë‹¤.",
            "í•œ ê±¸ìŒë§Œ ë–¼ë©´ ìƒê°ë³´ë‹¤ ì‰½ê²Œ í’€ë¦½ë‹ˆë‹¤.",
            "ì¤€ë¹„ëœ ì‚¬ëŒì—ê²Œ ê¸°íšŒëŠ” ê¼­ ì°¾ì•„ì˜µë‹ˆë‹¤.",
            "ì‘ê²Œ ì‹œì‘í•´ë„ ê´œì°®ì•„ìš”. ì‹œì‘ì´ ë°˜ì…ë‹ˆë‹¤.",
            "ìš©ê¸° ë‚´ë©´ ì¢‹ì€ ê²°ê³¼ê°€ ë”°ë¼ì˜µë‹ˆë‹¤.",
            "ì§€ê¸ˆ ì„±ì‹¤í•¨ì´ ë‚˜ì¤‘ì— ë“ ë“ í•œ í˜ì´ ë©ë‹ˆë‹¤.",
            "ìƒê°ë³´ë‹¤ í›¨ì”¬ ì˜í•˜ê³  ìˆì–´ìš”. ìì‹ ê° ê°€ì§€ì„¸ìš”.",

            // ğŸŒ± ì„±ì¥ (ìœ ì§€)
            "ì‹¤ìˆ˜ëŠ” ë°°ìš°ëŠ” ê³¼ì •ì…ë‹ˆë‹¤. ê´œì°®ì•„ìš”.",
            "ì˜¤ëŠ˜ ì„ íƒì´ ë‚´ì¼ì„ ë§Œë“­ë‹ˆë‹¤. ì‹ ì¤‘í•˜ë˜ ë¶€ë‹´ ê°–ì§€ ë§ˆì„¸ìš”.",
            "ë°°ìš°ë ¤ëŠ” ìì„¸ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.",
            "ìƒˆë¡œìš´ ì‹œë„ëŠ” ìƒˆë¡œìš´ ê°€ëŠ¥ì„±ì…ë‹ˆë‹¤.",
            "ë³€í™”ëŠ” ë¬´ì„­ì§€ë§Œ ì„±ì¥ì˜ ê¸°íšŒì…ë‹ˆë‹¤.",
            "ì¡°ê¸ˆë§Œ ë‹¤ë¥´ê²Œ ë³´ë©´ ë‹µì´ ë³´ì…ë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ ë°°ìš´ ê²ƒì´ ë‚´ì¼ í˜ì´ ë©ë‹ˆë‹¤.",
            "ê¾¸ì¤€í•¨ì´ ì¬ëŠ¥ì„ ì´ê¹ë‹ˆë‹¤.",

            // ğŸŒ í–‰ìš´ (ìœ ì§€)
            "ì˜¤ëŠ˜ ì¢‹ì€ ì¼ í•˜ë‚˜ ìƒê¸¸ ê±°ì˜ˆìš”.",
            "í‰ë²”í•œ ì˜¤ëŠ˜ì´ íŠ¹ë³„í•´ì§€ëŠ” ë‚ ì…ë‹ˆë‹¤.",
            "ì¢‹ì€ ì†Œì‹ì´ ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.",
            "ì˜ˆìƒì¹˜ ëª»í•œ ê³³ì—ì„œ ë„ì›€ì´ ì˜µë‹ˆë‹¤.",
            "ì˜¤ëŠ˜ì€ ëª¨ë“  ì¼ì´ ì˜ í’€ë¦´ ê±°ì˜ˆìš”.",
            "ì‘ì€ ì„ íƒì´ í° í–‰ìš´ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            "ì´ë¯¸ ë§ì€ í–‰ìš´ì´ í•¨ê»˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
            "ì¡°ìš©í•œ í–‰ë³µì´ í•˜ë£¨ ì¢…ì¼ í•¨ê»˜í•  ê±°ì˜ˆìš”."
        ];

        let membersData = [];
        let chartTotal = null;
        let chartInd = null;
        let scratchCanvas = null;
        let scratchCtx = null;
        let isDrawing = false;
        let currentScratchMember = null;

        // Init
        const today = new Date();
        document.getElementById('header-date').innerText = `${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;

        auth.onAuthStateChanged(user => {
            if (!user) {
                location.href = '../login.html';
            } else {
                loadFamilyData(user);
            }
        });

        // Simple seeded random function
        function seededRandom(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            const x = Math.sin(hash) * 10000;
            return x - Math.floor(x);
        }

        async function loadFamilyData(user) {
            try {
                const names = Object.keys(familyData);
                membersData = names.map(name => ({
                    name: name,
                    birthdate: familyData[name].birthdate
                }));

                renderTabs();
                renderTotalChart();

                // [NEW] Auto-select tab for logged-in user
                const storedName = sessionStorage.getItem('user_name');
                if (storedName) {
                    const myIdx = membersData.findIndex(m => m.name === storedName);
                    if (myIdx !== -1) {
                        switchTab(myIdx);
                    }
                }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
            }
        }

        function renderTabs() {
            const container = document.getElementById('tab-nav');
            // Reset tabs (keep first one "Total")
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            membersData.forEach((m, idx) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = m.name;
                btn.onclick = (e) => switchTab(idx, e);
                container.appendChild(btn);
            });
        }

        window.switchTab = function (tabId, event) {
            // UI Toggle
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(b => b.classList.remove('active'));

            if (event) {
                event.target.classList.add('active');
            } else {
                // Fallback or Initial
            }

            if (tabId === 'total') {
                document.getElementById('section-total').classList.remove('hidden');
                document.getElementById('section-individual').classList.add('hidden');
                document.getElementById('total-scratch-section').classList.remove('hidden'); // Show Guide
                renderTotalChart();
            } else {
                document.getElementById('section-total').classList.add('hidden');
                document.getElementById('section-individual').classList.remove('hidden');
                document.getElementById('total-scratch-section').classList.add('hidden'); // Hide Guide
                renderIndividual(membersData[tabId]);
            }
        }

        function getBiorhythm(birthStr, targetDate) {
            const birth = new Date(birthStr);
            const diffTime = targetDate - birth;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            const phys = Math.sin(2 * Math.PI * diffDays / 23) * 100;
            const emo = Math.sin(2 * Math.PI * diffDays / 28) * 100;
            const intel = Math.sin(2 * Math.PI * diffDays / 33) * 100;

            return { phys, emo, intel, avg: (phys + emo + intel) / 3 };
        }

        function renderTotalChart() {
            if (chartTotal) chartTotal.destroy();

            const labels = [];
            const dataScores = [];
            const bgColors = [];

            membersData.forEach(m => {
                if (!m.birthdate) return;
                const bio = getBiorhythm(m.birthdate, new Date());
                labels.push(m.name);
                dataScores.push(bio.avg);

                if (bio.avg > 50) bgColors.push('#22c55e');
                else if (bio.avg > 0) bgColors.push('#fbbf24');
                else bgColors.push('#ef4444');
            });

            let maxScore = -100;
            let bestMember = "";
            dataScores.forEach((s, i) => {
                if (s > maxScore) { maxScore = s; bestMember = labels[i]; }
            });

            document.getElementById('total-comment').innerText =
                `ì˜¤ëŠ˜ ì»¨ë””ì…˜ ì™•ì€ ğŸ‘‘ ${bestMember}ë‹˜! (${Math.round(maxScore)}ì )`;

            const ctx = document.getElementById('totalChart').getContext('2d');
            chartTotal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¢…í•© ì»¨ë””ì…˜ ì ìˆ˜',
                        data: dataScores,
                        backgroundColor: bgColors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: -100, max: 100, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderIndividual(member) {
            if (!member || !member.birthdate) return;

            document.getElementById('ind-name-title').innerText = `${member.name}ë‹˜ì˜ ìš´ì„¸`;

            // 1. Static Info (Zodiac)
            const z1 = getZodiac(member.birthdate);
            const z2 = getChineseZodiac(member.birthdate);
            document.getElementById('zodiac-text').innerText = `${member.birthdate} (${z1}/${z2})`;

            // 2. Daily Fortune (Engine)
            const fortune = getDailyFortune(member.name, member.birthdate);
            const keywordEl = document.getElementById('daily-keyword');

            if (fortune) {
                // Colorize status
                const colorMap = { high: '#22c55e', mid: '#3b82f6', low: '#ef4444' };
                const color = colorMap[fortune.status] || '#555';

                keywordEl.innerHTML = `
                    <div style="text-align:center; padding:5px 0 10px 0;">
                        <div style="font-size:1.1rem; font-weight:bold; color:${color}; margin-bottom:5px;">
                            ${fortune.text.split(']')[0]}]
                        </div>
                        <div style="line-height:1.6; color:#333;">
                            ${fortune.text.split(']')[1] || fortune.text}
                        </div>
                        <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #eee; font-size:0.85rem; color:#666; display:flex; justify-content:space-around;">
                            <span>âœ¨ í–‰ìš´ìƒ‰: <b>${fortune.lucky.color}</b></span>
                            <span>ğŸ‘œ ì•„ì´í…œ: <b>${fortune.lucky.item}</b></span>
                            <span>ğŸƒ ì•¡ì…˜: <b>${fortune.lucky.action}</b></span>
                        </div>
                    </div>
                `;
            } else {
                keywordEl.innerText = "ìš´ì„¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }

            // 3. Fortune Cookie (Seeded by Name + Date + 'cookie')
            const dateStr = `${today.getFullYear()}${today.getMonth()}${today.getDate()}`;
            const seed = member.name + dateStr;
            const cookieSeed = seed + 'cookie';
            const cookieRand = seededRandom(cookieSeed);
            const cookieIdx = Math.floor(cookieRand * fortuneCookies.length);

            document.getElementById('fortune-msg').innerText = `"${fortuneCookies[cookieIdx]}"`;

            // 4. Scratch Canvas Reset
            // [FIX] Add delay to ensure DOM is visible and has dimensions before init
            setTimeout(() => {
                initScratchCanvas(member.name);
            }, 100);

            // 5. Bio Chart
            if (chartInd) chartInd.destroy();

            const labels = [];
            const dP = [], dE = [], dI = [];
            const todayD = new Date();

            for (let i = -3; i <= 3; i++) {
                const d = new Date(todayD);
                d.setDate(todayD.getDate() + i);
                labels.push(`${d.getMonth() + 1}/${d.getDate()}`);

                const bio = getBiorhythm(member.birthdate, d);
                dP.push(bio.phys);
                dE.push(bio.emo);
                dI.push(bio.intel);
            }

            const ctx = document.getElementById('indChart').getContext('2d');
            chartInd = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ì‹ ì²´', data: dP, borderColor: '#22c55e', tension: 0.4, pointRadius: 3 },
                        { label: 'ê°ì„±', data: dE, borderColor: '#ef4444', tension: 0.4, pointRadius: 3 },
                        { label: 'ì§€ì„±', data: dI, borderColor: '#3b82f6', tension: 0.4, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: -100, max: 100, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Scratch Logic ---
        function initScratchCanvas(memberName) {
            // Need to check if user switched tab, scratch should be reset? 
            // Yes, user wants "scratch card" experience effectively per member view.

            const canvas = document.getElementById('scratchCanvas');
            const parent = document.getElementById('scratch-wrapper');
            const hint = document.getElementById('scratch-hint');

            if (!canvas || !parent) return;

            scratchCtx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = parent.offsetWidth;
            canvas.height = parent.offsetHeight;

            // Fill with gray/silver
            scratchCtx.globalCompositeOperation = 'source-over';
            scratchCtx.fillStyle = '#cccccc'; // silver
            scratchCtx.fillRect(0, 0, canvas.width, canvas.height);

            // Decoration text "Scratch Me"
            scratchCtx.fillStyle = '#999';
            scratchCtx.font = '20px sans-serif';
            scratchCtx.textAlign = 'center';
            scratchCtx.fillText("ğŸ€ ê¸ì–´ì„œ í–‰ìš´ í™•ì¸!", canvas.width / 2, canvas.height / 2);

            // Reset Drawing State
            isDrawing = false;
            hint.style.display = 'block'; // Show hint again

            // Event Listeners (ensure we don't duplicate if called multiple times)
            // It's safer to recreate or remove old listeners, but for simplicity here we assume simple switching.
            // Using 'on' properties to override previous handlers easily.

            canvas.onmousedown = startScratch;
            canvas.onmousemove = scratch;
            canvas.onmouseup = endScratch;
            canvas.onmouseleave = endScratch;

            // Touch support
            canvas.ontouchstart = (e) => { e.preventDefault(); startScratch(e.touches[0]); };
            canvas.ontouchmove = (e) => { e.preventDefault(); scratch(e.touches[0]); };
            canvas.ontouchend = endScratch;
        }

        function startScratch(e) {
            isDrawing = true;
            document.getElementById('scratch-hint').style.display = 'none'; // Hide hint once started
            scratch(e);
        }

        function scratch(e) {
            if (!isDrawing) return;

            const canvas = document.getElementById('scratchCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            scratchCtx.globalCompositeOperation = 'destination-out';
            scratchCtx.beginPath();
            scratchCtx.arc(x, y, 20, 0, Math.PI * 2); // Brush size
            scratchCtx.fill();
        }

        function endScratch() {
            isDrawing = false;
            // Check percent cleared? (Optional enhancement)
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            // Ideally resize canvas but that would clear it. Let's ignore for MVP.
        });

    </script>
</body>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('../sw.js')
                .then(reg => console.log('SW registered!', reg))
                .catch(err => console.log('SW registration failed: ', err));
        });
    }
</script>
</body>

</html>