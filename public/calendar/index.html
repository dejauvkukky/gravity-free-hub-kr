<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Garden - Í∞ÄÏ°± ÏùºÏ†ï</title>
    <link rel="stylesheet" href="../../assets/css/style.css?v=40">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../assets/icons/icon-192.png">
    <meta name="theme-color" content="#6366f1">
    <style>
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .calendar-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--color-primary);
            cursor: pointer;
            padding: 5px 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .calendar-cell {
            aspect-ratio: 1;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 8px;
            cursor: pointer;
            position: relative;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .calendar-cell:hover {
            border-color: var(--color-primary);
        }

        .calendar-cell.selected {
            box-shadow: 0 0 0 2px var(--color-primary) inset;
        }

        /* Feature: Highlights */
        .calendar-cell.has-event {
            background-color: #f0fdf4;
            /* Light Green */
            border-color: #bbf7d0;
        }

        .calendar-cell.is-holiday {
            background-color: #fef2f2;
            /* Light Red */
            border-color: #fecaca;
        }

        .calendar-cell.is-holiday span:first-child {
            color: #ef4444;
            font-weight: 800;
        }

        .calendar-cell.today {
            font-weight: bold;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .calendar-cell.other-month {
            opacity: 0.3;
            pointer-events: none;
        }

        .weekday-header {
            font-size: 0.8rem;
            text-align: center;
            color: #888;
            margin-bottom: 5px;
        }

        .event-dots {
            display: flex;
            gap: 2px;
            margin-top: 4px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .event-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--color-secondary);
        }

        .event-dot.holiday-dot {
            background-color: #ef4444;
        }

        .detail-day {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .month-list {
            background: linear-gradient(135deg, #ffffff 0%, #fffbf0 100%);
            /* Subtle warmth */
            border-radius: 16px;
            padding: 25px;
            /* More padding */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            /* Deeper shadow for pop */
            border: 1px solid #f0f0f0;
            border-left: 6px solid var(--color-secondary);
            /* Distinct accent */
            position: relative;
            overflow: hidden;
        }

        /* Decorative icon for the list */
        .month-list::after {
            content: "üìÖ";
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 5rem;
            opacity: 0.05;
            transform: rotate(15deg);
            pointer-events: none;
        }

        .event-item {
            display: flex;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-date {
            font-size: 0.85rem;
            color: #666;
            width: 50px;
            flex-shrink: 0;
            font-weight: bold;
        }

        .event-content {
            flex-grow: 1;
            font-size: 0.95rem;
            color: #333;
        }

        .event-meta {
            font-size: 0.75rem;
            color: #aaa;
            margin-top: 2px;
        }

        .holiday-badge {
            font-size: 0.7rem;
            color: #ef4444;
            background: #fee2e2;
            padding: 2px 4px;
            border-radius: 4px;
            margin-right: 5px;
            font-weight: bold;
        }

        .delete-btn {
            color: #ef4444;
            font-size: 0.8rem;
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            padding: 2px 5px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-card {
            background: white;
            width: 85%;
            max-width: 320px;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .add-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 15px;
        }

        .add-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <a href="../dashboard.html" class="logo">‚Üê Secret Garden</a>
            <span>Í∞ÄÏ°± ÏùºÏ†ï</span>
        </header>

        <div id="loading" class="p-4 text-center">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>

        <div id="content" class="p-4 hidden">
            <!-- Calendar Card -->
            <div class="card" style="padding: 20px; margin-bottom: 20px;">
                <!-- Calendar View -->
                <div class="calendar-header">
                    <button class="calendar-btn" onclick="changeMonth(-1)">‚óÄ</button>
                    <h2 style="font-size: 1.4rem; color: #333; margin: 0;" id="current-month">2023.12</h2>
                    <button class="calendar-btn" onclick="changeMonth(1)">‚ñ∂</button>
                </div>

                <!-- Grid Header -->
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px;">
                    <div class="weekday-header" style="color:#ef4444">Ïùº</div>
                    <div class="weekday-header">Ïõî</div>
                    <div class="weekday-header">Ìôî</div>
                    <div class="weekday-header">Ïàò</div>
                    <div class="weekday-header">Î™©</div>
                    <div class="weekday-header">Í∏à</div>
                    <div class="weekday-header" style="color:#3b82f6">ÌÜ†</div>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Selected Date Detail -->
            <div class="detail-day" id="detail-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="font-size:1.1rem; color:var(--color-primary); margin:0;" id="selected-date-title">Day
                    </h3>
                    <button class="btn btn-primary" onclick="openModal()"
                        style="width:auto; padding:6px 14px; font-size:0.85rem;">+ ÏùºÏ†ï Ï∂îÍ∞Ä</button>
                </div>
                <div id="selected-date-list">
                    <!-- Events for this day -->
                </div>
            </div>

            <!-- Monthly List -->
            <div class="month-list">
                <h3 style="font-size: 1.1rem; margin-bottom: 15px; color: #333;">üìÖ Ïù¥Îã¨Ïùò ÏùºÏ†ï</h3>
                <div id="month-event-list">
                    <!-- List items -->
                    <p style="text-align:center; color:#999; font-size:0.9rem;">Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal HTML -->
    <div id="schedule-modal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="margin-top:0; color:#333; margin-bottom: 5px;">üìù ÏùºÏ†ï Îì±Î°ù</h3>
            <p id="modal-date-display" style="color:#888; font-size:0.9rem; margin-bottom:20px;"></p>

            <form onsubmit="addSchedule(event)">
                <input type="text" id="modal-input" class="add-input" placeholder="ÏùºÏ†ï ÎÇ¥Ïö©" required>

                <div id="admin-options"
                    style="display:none; margin-bottom:20px; background:#fff5f5; padding:10px; border-radius:8px;">
                    <label
                        style="display:flex; align-items:center; gap:8px; font-size:0.9rem; color:#ef4444; font-weight:bold; cursor:pointer;">
                        <input type="checkbox" id="modal-holiday-check" style="width:18px; height:18px;"> Í≥µÌú¥Ïùº(Îπ®Í∞ÑÎÇ†)Î°ú ÏßÄÏ†ï
                    </label>
                </div>

                <div style="display:flex; gap:10px;">
                    <button type="button" class="btn" onclick="closeModal()"
                        style="background:#f1f5f9; color:#64748b; flex:1;">Ï∑®ÏÜå</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">Îì±Î°ù</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { auth, db } from '../../src/firebase.js?v=40';
        const COLLECTION = 'family_schedules';

        let currentDate = new Date();
        let selectedDate = new Date();
        let monthEvents = [];
        let currentUser = null;
        let isAdmin = false;

        // Init
        auth.onAuthStateChanged(user => {
            if (!user) {
                location.href = '../login.html';
            } else {
                currentUser = user;
                // Admin ID Check (kukky@family.com)
                isAdmin = (user.email === 'kukky@family.com');

                initCalendar();
            }
        });

        async function initCalendar() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            await loadMonthEvents();
            renderCalendar();
            renderMonthList();

            // Select today if in current month
            const today = new Date();
            if (today.getMonth() === currentDate.getMonth() && today.getFullYear() === currentDate.getFullYear()) {
                selectDate(today);
            } else {
                selectDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), 1));
            }

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        async function loadMonthEvents() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const startStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const endStr = `${year}-${String(month + 1).padStart(2, '0')}-31`;

            try {
                const snapshot = await db.collection(COLLECTION)
                    .where('date', '>=', startStr)
                    .where('date', '<=', endStr)
                    .get();

                monthEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                monthEvents.sort((a, b) => a.date.localeCompare(b.date));
            } catch (e) {
                console.error("Load failed", e);
                monthEvents = [];
            }
        }

        window.changeMonth = async function (dir) {
            currentDate.setMonth(currentDate.getMonth() + dir);
            await loadMonthEvents();
            renderCalendar();
            renderMonthList();
            selectDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), 1));
        }

        function renderCalendar() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();

            document.getElementById('current-month').innerText = `${y}.${String(m + 1).padStart(2, '0')}`;

            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            const firstDay = new Date(y, m, 1);
            const lastDay = new Date(y, m + 1, 0);

            for (let i = 0; i < firstDay.getDay(); i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell other-month';
                grid.appendChild(cell);
            }

            const today = new Date();
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dateObj = new Date(y, m, d);
                const dateStr = formatDate(dateObj);

                const cell = document.createElement('div');
                cell.className = 'calendar-cell';

                if (dateStr === formatDate(today)) cell.classList.add('today');
                if (selectedDate && formatDate(selectedDate) === dateStr) {
                    cell.classList.add('selected');
                }

                // Check Events
                const dayEvents = monthEvents.filter(e => e.date === dateStr);
                const isHoliday = dayEvents.some(e => e.isHoliday);

                if (dayEvents.length > 0) {
                    cell.classList.add('has-event');
                }
                if (isHoliday) {
                    cell.classList.add('is-holiday');
                }

                cell.onclick = () => selectDate(dateObj);

                const numSpan = document.createElement('span');
                numSpan.innerText = d;
                cell.appendChild(numSpan);

                // Dots
                if (dayEvents.length > 0) {
                    const dotsC = document.createElement('div');
                    dotsC.className = 'event-dots';
                    dayEvents.slice(0, 3).forEach(evt => {
                        const dot = document.createElement('div');
                        dot.className = 'event-dot';
                        if (evt.isHoliday) dot.classList.add('holiday-dot');
                        dotsC.appendChild(dot);
                    });
                    if (dayEvents.length > 3) {
                        // + mark
                    }
                    cell.appendChild(dotsC);
                }

                grid.appendChild(cell);
            }
        }

        function selectDate(dateObj) {
            selectedDate = dateObj;

            const cells = document.querySelectorAll('.calendar-cell');
            cells.forEach(c => c.classList.remove('selected'));
            renderCalendar();

            const section = document.getElementById('detail-section');
            section.style.display = 'block';

            const m = dateObj.getMonth() + 1;
            const d = dateObj.getDate();
            const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
            document.getElementById('selected-date-title').innerText = `${m}Ïõî ${d}Ïùº (${days[dateObj.getDay()]})`;

            renderDayList(formatDate(dateObj));
        }

        function renderDayList(dateStr) {
            const listEl = document.getElementById('selected-date-list');
            listEl.innerHTML = '';

            const dayEvents = monthEvents.filter(e => e.date === dateStr);
            if (dayEvents.length === 0) {
                listEl.innerHTML = '<p style="font-size:0.9rem; color:#aaa; margin-bottom:0;">Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            dayEvents.forEach(evt => {
                const div = document.createElement('div');
                div.className = 'event-item';
                div.style.alignItems = 'center';

                let titleHtml = evt.title;
                if (evt.isHoliday) {
                    titleHtml = `<span class="holiday-badge">Í≥µÌú¥Ïùº</span> <span style="color:#ef4444; font-weight:bold;">${evt.title}</span>`;
                }

                let html = `
                    <div class="event-content">
                        ${titleHtml}
                        <div class="event-meta">by ${evt.author}</div>
                    </div>
                `;

                // Allow delete if author or if admin & holiday
                const canDelete = (currentUser.uid === evt.uid) || (isAdmin && evt.isHoliday);

                if (canDelete) {
                    html += `<button class="delete-btn" onclick="window.deleteSchedule('${evt.id}')">ÏÇ≠Ï†ú</button>`;
                }

                div.innerHTML = html;
                listEl.appendChild(div);
            });
        }

        // --- Modal Logic ---
        window.openModal = function () {
            const modal = document.getElementById('schedule-modal');
            const dateDisplay = document.getElementById('modal-date-display');
            const holidayOption = document.getElementById('admin-options');

            const d = selectedDate;
            dateDisplay.innerText = `${d.getFullYear()}ÎÖÑ ${d.getMonth() + 1}Ïõî ${d.getDate()}Ïùº ÏùºÏ†ï Ï∂îÍ∞Ä`;

            // Admin Check
            if (isAdmin) {
                holidayOption.style.display = 'block';
            } else {
                holidayOption.style.display = 'none';
            }

            // Reset fields
            document.getElementById('modal-input').value = '';
            document.getElementById('modal-holiday-check').checked = false;

            modal.style.display = 'flex';
            document.getElementById('modal-input').focus();
        }

        window.closeModal = function () {
            document.getElementById('schedule-modal').style.display = 'none';
        }

        window.addSchedule = async function (e) {
            e.preventDefault();
            const title = document.getElementById('modal-input').value.trim();
            const isHoliday = document.getElementById('modal-holiday-check').checked;

            if (!title) return;
            // Safety: Only admin can set holiday
            if (isHoliday && !isAdmin) return;

            const dateStr = formatDate(selectedDate);

            let nickname = sessionStorage.getItem('user_name');
            if (!nickname) nickname = currentUser.email.split('@')[0];

            // If holiday, override nickname
            if (isHoliday) nickname = "Í¥ÄÎ¶¨Ïûê";

            try {
                await db.collection(COLLECTION).add({
                    date: dateStr,
                    title: title,
                    uid: currentUser.uid,
                    author: nickname,
                    createdAt: new Date(),
                    isHoliday: isHoliday
                });

                closeModal();
                await loadMonthEvents();
                renderCalendar();
                renderMonthList();
                renderDayList(dateStr);
            } catch (err) {
                alert('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
            }
        }

        window.deleteSchedule = async function (docId) {
            if (!confirm('ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            try {
                await db.collection(COLLECTION).doc(docId).delete();
                await loadMonthEvents();
                renderCalendar();
                renderMonthList();
                renderDayList(formatDate(selectedDate));
            } catch (err) {
                alert('ÏÇ≠Ï†ú Ïã§Ìå®: ' + err.message);
            }
        }

        function renderMonthList() {
            const listEl = document.getElementById('month-event-list');
            if (monthEvents.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color:#999; font-size:0.9rem;">Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            let html = '';
            monthEvents.forEach(evt => {
                const d = new Date(evt.date);
                const dStr = `${d.getMonth() + 1}/${d.getDate()}`;

                let titleHtml = evt.title;
                let rowStyle = '';

                if (evt.isHoliday) {
                    titleHtml = `<span style="color:#ef4444; font-weight:bold;">${evt.title}</span>`;
                    rowStyle = 'background:#fef2f2;';
                }

                html += `
                    <div class="event-item" style="${rowStyle}">
                        <div class="event-date" style="${evt.isHoliday ? 'color:#ef4444' : ''}">${dStr}</div>
                        <div class="event-content">
                            ${titleHtml}
                            <div class="event-meta">by ${evt.author}</div>
                        </div>
                    </div>
                 `;
            });
            listEl.innerHTML = html;
        }

        function formatDate(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    </script>
</body>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('../sw.js')
                .then(reg => console.log('SW registered!', reg))
                .catch(err => console.log('SW registration failed: ', err));
        });
    }
</script>
</body>

</html>