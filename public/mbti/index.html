<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Garden MBTI</title>
    <link rel="stylesheet" href="../../assets/css/style.css?v=14">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .option-btn {
            display: block;
            width: 100%;
            padding: 20px;
            margin-bottom: 12px;
            border: 2px solid #eee;
            border-radius: 12px;
            background: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .option-btn:hover {
            border-color: var(--color-coral);
            background: #fff5f5;
        }

        .family-result-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .family-result-card:hover {
            background: white;
            border-color: var(--color-coral);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .family-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .family-detail {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }

        .family-result-card.expanded .family-detail {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .intro-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .match-card {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <a href="../dashboard.html" class="logo">â† Secret Garden</a>
            <span>MBTI Test</span>
        </header>

        <!-- Loading -->
        <div id="loading" class="p-4 text-center hidden">ë¡œë”©ì¤‘...</div>

        <!-- Intro Screen -->
        <div class="p-4 flex-grow flex flex-col" id="intro-screen">
            <div class="text-center" style="margin-bottom: 30px; margin-top: 20px;">
                <h1 style="font-size: 2rem; color: var(--color-coral); margin-bottom: 10px;">Secret MBTI</h1>
                <p style="color: #666;">ì„œë¡œë¥¼ ë” ê¹Šì´ ì´í•´í•˜ëŠ” ì‹œê°„ â¤ï¸</p>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 1.1rem; margin-bottom: 15px; color: #333;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡±ë“¤ì˜ ê²°ê³¼</h3>
                <div id="family-intro-list">
                    <!-- Loaded dynamically -->
                    <p style="text-align: center; color: #999; padding: 20px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>

            <div style="flex-grow: 1;"></div>

            <button class="btn btn-primary" onclick="startQuiz()">í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸° (12ë¬¸í•­)</button>
        </div>

        <!-- Quiz Screen -->
        <div class="p-4 flex-grow flex flex-col justify-center hidden" id="quiz-screen">
            <div style="background: #eee; height: 10px; border-radius: 5px; margin-bottom: 30px;">
                <div id="progress-bar"
                    style="background: var(--color-coral); height: 100%; width: 0%; border-radius: 5px; transition: width 0.3s;">
                </div>
            </div>

            <div style="margin-bottom: 40px;">
                <span style="color: var(--color-coral); font-weight: bold; display: block; margin-bottom: 8px;">Q<span
                        id="q-num">1</span></span>
                <h2 id="question-text" style="font-size: 1.4rem; line-height: 1.4;">ì§ˆë¬¸ ë‚´ìš©</h2>
            </div>

            <button class="option-btn" id="btn-a" onclick="handleAnswer('a')">A ë‹µë³€</button>
            <button class="option-btn" id="btn-b" onclick="handleAnswer('b')">B ë‹µë³€</button>
        </div>

        <!-- Result Screen -->
        <div class="p-4 hidden" id="result-screen" style="overflow-y: auto;">
            <div class="text-center" style="margin-top: 10px;">
                <img id="result-img" src="" alt="Character"
                    style="width: 120px; height: 120px; border-radius: 50%; background: #f0f0f0; margin-bottom: 15px; object-fit: cover;">

                <p style="color: #666; margin-bottom: 4px; font-size: 0.9rem;">ë‹¹ì‹ ì˜ ì„±ê²© ìœ í˜•ì€</p>
                <div id="result-type"
                    style="font-size: 3rem; font-weight: 800; color: var(--color-coral); line-height: 1;">TYPE</div>
                <div id="result-name" style="font-size: 1.2rem; font-weight: bold; margin: 10px 0 20px 0; color: #333;">
                    ìœ í˜• ì´ë¦„</div>

                <div class="card" style="margin: 0 0 20px 0; text-align: left;">
                    <p id="result-desc" style="line-height: 1.6; color: #555;">ì„¤ëª…</p>
                </div>

                <!-- Match Info -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <div class="match-card" style="background-color: #fca5a5;">
                        <span style="display:block; font-size:0.8rem; margin-bottom:5px; opacity:0.9;">â¤ï¸ ì°°ë–¡ ê¶í•©</span>
                        <strong id="match-best" style="font-size:1.2rem;">ENFP</strong>
                    </div>
                    <div class="match-card" style="background-color: #93c5fd;">
                        <span style="display:block; font-size:0.8rem; margin-bottom:5px; opacity:0.9;">âš¡ ì¡°ê¸ˆ í˜ë“ </span>
                        <strong id="match-worst" style="font-size:1.2rem;">ESTJ</strong>
                    </div>
                </div>

                <div class="card"
                    style="margin: 0 0 20px 0; text-align: left; background-color: #f0fdf4; border: 1px solid #bbf7d0;">
                    <h3 style="font-size: 1rem; color: #166534; margin-top: 0;">ğŸ’¡ ê°€ì¡±ì„ ìœ„í•œ íŒ</h3>
                    <p id="result-tips" style="line-height: 1.6; color: #15803d; margin-bottom: 0;">íŒ ë‚´ìš©</p>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

            <div>
                <h3 style="font-size: 1.2rem; margin-bottom: 16px;">ğŸ“Š ê°€ì¡± ê¶í•© ë­í‚¹</h3>
                <div style="margin-bottom: 20px; height: 200px;">
                    <canvas id="familyChart"></canvas>
                </div>

                <div id="family-list">
                    <!-- Family List Items -->
                </div>
            </div>

            <button class="btn btn-primary mt-4" style="margin-bottom: 30px;"
                onclick="location.href='../dashboard.html'">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            <div style="text-align: center; color: #ccc; font-size: 0.7rem; margin-bottom: 20px;">v1.5 (Fixed Missing
                List & History Time)</div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { auth, db } from '../../src/firebase.js?v=14';
        import { results, getCompatibility, generateQuiz, questions } from '../../src/mbti_data.js?v=9';

        // Globals
        window.questions = questions; // Fallback or use generated
        window.results = results;
        window.getCompatibility = getCompatibility;
        window.generateQuiz = generateQuiz;
        window.db = db;
        window.auth = auth;
        window.currentQ = 0;
        window.quiz = [];
        window.scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };

        // Initialization
        auth.onAuthStateChanged(user => {
            if (!user) {
                location.href = '../login.html';
            } else {
                initIntro();
            }
        });

        // Intro Logic
        async function initIntro() {
            const listEl = document.getElementById('family-intro-list');
            listEl.innerHTML = '';

            try {
                const snapshot = await db.collection('mbti_results_v2').get();
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-gray-400">ì•„ì§ ë“±ë¡ëœ ê°€ì¡±ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!</p>';
                    return;
                }

                // Find my MBTI first
                let myMbti = null;
                const currentUser = window.auth.currentUser;
                if (currentUser) {
                    const myDoc = snapshot.docs.find(d => d.id === currentUser.uid);
                    if (myDoc) myMbti = myDoc.data().mbti;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const info = window.results[data.mbti];
                    const isMe = (currentUser && currentUser.uid === data.uid);

                    // Calc Score
                    let scoreHtml = '';
                    if (isMe) {
                        scoreHtml = '<div style="font-weight:bold; font-size:1.0rem; color:var(--color-coral); margin-bottom:2px;">ME</div>';
                    } else if (myMbti) {
                        const score = window.getCompatibility(myMbti, data.mbti);
                        const scoreColor = score >= 80 ? '#ef4444' : (score >= 50 ? '#d97706' : '#666');
                        scoreHtml = `
                            <div style="text-align:right;">
                                <span style="display:block; font-size:0.7rem; color:#aaa; margin-bottom:2px;">ê¶í•©ì ìˆ˜</span>
                                <div style="font-weight:bold; font-size:1.2rem; color:${scoreColor}; line-height:1;">
                                    ${score}ì  ${score >= 80 ? 'â¤ï¸' : ''}
                                </div>
                            </div>
                         `;
                    } else {
                        scoreHtml = '<div style="font-size:0.8rem; color:#aaa; margin-bottom:2px;">? ì </div>';
                    }

                    // Build History HTML
                    let historyHtml = '';
                    if (data.history && data.history.length > 0) {
                        const historySorted = [...data.history].sort((a, b) => b.date.seconds - a.date.seconds);
                        historyHtml += '<div style="margin-bottom: 20px; border-top: 1px dashed #eee; padding-top: 15px;">';
                        historyHtml += '<h4 style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">ğŸ“œ MBTI ë³€ì²œì‚¬</h4>';
                        historyHtml += '<ul style="list-style:none; padding:0; margin:0;">';

                        historySorted.forEach((rec, idx) => {
                            const date = new Date(rec.date.seconds * 1000);
                            const dateStr = `${date.getFullYear()}.${date.getMonth() + 1}.${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                            const isLatest = (idx === 0);

                            historyHtml += `
                                <li style="display:flex; justify-content:space-between; padding: 6px 0; font-size: 0.85rem; align-items:center;">
                                    <span style="color:#888;">${dateStr}</span>
                                    <span style="font-weight:bold; color:${isLatest ? 'var(--color-coral)' : '#555'};">
                                        ${rec.mbti} ${isLatest ? '<span style="font-size:0.6rem; background:var(--color-coral); color:white; padding:1px 5px; border-radius:8px; margin-left:4px;">í˜„ì¬</span>' : ''}
                                    </span>
                                </li>
                            `;
                        });
                        historyHtml += '</ul></div>';
                    }

                    const el = document.createElement('div');
                    el.className = 'family-result-card';
                    el.onclick = function () {
                        this.classList.toggle('expanded');
                    }

                    el.innerHTML = `
                        <div class="family-result-header" style="justify-content: flex-start; gap: 15px;">
                            <img src="${info.img}" style="width:50px; height:50px; border-radius:50%; background:#f0f0f0; object-fit: cover;">
                            <div>
                                <div style="font-weight:bold; font-size:1.1rem; color:#333;">
                                    ${data.name} <span style="color:var(--color-coral); margin-left:5px;">${data.mbti}</span>
                                </div>
                                <div style="color:#888; font-size:0.9rem;">
                                    ${info.name}
                                </div>
                            </div>
                            <div style="margin-left:auto; text-align:right;">
                                ${scoreHtml}
                                <div style="font-size:0.8rem; color:#aaa;">í„°ì¹˜í•˜ì—¬ ìƒì„¸</div>
                            </div>
                        </div>
                        <div class="family-detail">
                            <p style="line-height: 1.6; color: #555; margin-bottom: 20px;">${info.desc}</p>
                            
                            <h4 style="font-size:0.9rem; color:#666; margin-bottom:10px;">âœ¨ ìŠ¤íƒ€ì¼ & ê¶í•©</h4>
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <div class="match-card" style="background-color: #fca5a5; padding: 10px; border-radius: 8px; flex: 1; text-align: center;">
                                    <span style="display:block; font-size:0.8rem; margin-bottom:5px; opacity:0.9;">â¤ï¸ ìµœê³ ì˜ ì§ê¿</span>
                                    <strong style="font-size:1.1rem;">${info.matches.best}</strong>
                                </div>
                                <div class="match-card" style="background-color: #93c5fd; padding: 10px; border-radius: 8px; flex: 1; text-align: center;">
                                    <span style="display:block; font-size:0.8rem; margin-bottom:5px; opacity:0.9;">âš¡ ë…¸ë ¥ í•„ìš”</span>
                                    <strong style="font-size:1.1rem;">${info.matches.worst}</strong>
                                </div>
                            </div>

                            ${historyHtml}

                            <p style="margin-top:8px; color:#15803d; background:#f0fdf4; padding:8px; border-radius:4px;">ğŸ’¡ <strong>íŒ</strong>: ${info.tips}</p>
                        </div>
                    `;
                    listEl.appendChild(el);
                });
            } catch (e) {
                console.error(e);
                listEl.innerHTML = '<p style="text-align:center; color:red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        // Expose to window for button click
        window.startQuiz = function () {
            // Generate New Quiz
            window.quiz = window.generateQuiz();
            window.currentQ = 0;
            window.scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };

            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');

            renderQuestion();
        }

        // Quiz Logic
        function renderQuestion() {
            const q = window.quiz[window.currentQ];
            document.getElementById('q-num').innerText = window.currentQ + 1;
            document.getElementById('question-text').innerText = q.t;
            document.getElementById('btn-a').innerText = q.a;
            document.getElementById('btn-b').innerText = q.b;

            const pct = ((window.currentQ) / window.quiz.length) * 100;
            document.getElementById('progress-bar').style.width = pct + "%";
        }

        window.handleAnswer = function (choice) {
            const q = window.quiz[window.currentQ];
            const typeChars = q.type.split('');
            if (choice === 'a') window.scores[typeChars[0]]++;
            else window.scores[typeChars[1]]++;

            window.currentQ++;
            if (window.currentQ < window.quiz.length) {
                renderQuestion();
            } else {
                finishQuiz();
            }
        }

        async function finishQuiz() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            let mbti = "";
            mbti += (window.scores.E >= window.scores.I) ? "E" : "I";
            mbti += (window.scores.S >= window.scores.N) ? "S" : "N";
            mbti += (window.scores.T >= window.scores.F) ? "T" : "F";
            mbti += (window.scores.J >= window.scores.P) ? "J" : "P";

            const user = window.auth.currentUser;
            const userRef = window.db.collection('mbti_results_v2').doc(user.uid);

            let nickname = sessionStorage.getItem('user_name');
            if (!nickname || nickname === 'null') {
                nickname = user.email.split('@')[0];
            }

            const timestamp = new Date();
            const newRecord = { mbti: mbti, date: timestamp };

            try {
                // Use arrayUnion to append history
                // We use global 'firebase' object from CDN
                await userRef.set({
                    uid: user.uid,
                    email: user.email,
                    name: nickname,
                    mbti: mbti, // Latest
                    timestamp: timestamp,
                    history: window.firebase.firestore.FieldValue.arrayUnion(newRecord)
                }, { merge: true });
            } catch (e) {
                console.error("Save failed", e);
            }

            // Pass mbti and userRef to show history
            showResultScreen(mbti, user.uid);
        }

        async function showResultScreen(myMbti, uid) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');

            const info = window.results[myMbti];

            document.getElementById('result-type').innerText = myMbti;
            document.getElementById('result-name').innerText = info.name;
            document.getElementById('result-desc').innerText = info.desc;
            document.getElementById('result-tips').innerText = info.tips;
            document.getElementById('result-img').src = info.img;

            document.getElementById('match-best').innerText = info.matches.best;
            document.getElementById('match-worst').innerText = info.matches.worst;

            // Render History
            if (uid) {
                renderHistory(uid);
            }

            loadFamilyResults(myMbti);
        }

        async function renderHistory(uid) {
            const historyEl = document.getElementById('history-section');
            if (!historyEl) {
                // Create container if not exists (insert before family chart)
                const container = document.createElement('div');
                container.id = 'history-section';
                container.style.marginBottom = '30px';
                container.innerHTML = '<h3 style="font-size: 1.2rem; margin-bottom: 16px;">ğŸ“œ ë‚˜ì˜ MBTI ë³€ì²œì‚¬</h3><div id="history-list" class="card" style="padding: 15px;"></div>';

                const target = document.querySelector('hr'); // Insert above HR
                target.parentNode.insertBefore(container, target);
            }

            const listEl = document.getElementById('history-list');
            listEl.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

            try {
                const doc = await window.db.collection('mbti_results_v2').doc(uid).get();
                if (doc.exists && doc.data().history) {
                    const history = doc.data().history;
                    // Sort by date desc
                    history.sort((a, b) => b.date.seconds - a.date.seconds);

                    let html = '';
                    if (history.length === 0) {
                        html = '<p style="color:#999;">ê¸°ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    } else {
                        html = '<ul style="list-style:none; padding:0; margin:0;">';
                        history.forEach((rec, idx) => {
                            const date = new Date(rec.date.seconds * 1000);
                            const dateStr = `${date.getFullYear()}.${date.getMonth() + 1}.${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                            const isLatest = (idx === 0);

                            html += `
                                <li style="display:flex; justify-content:space-between; padding: 10px 0; border-bottom: 1px dashed #eee; align-items:center;">
                                    <span style="color:#666; font-size:0.9rem;">${dateStr}</span>
                                    <span style="font-weight:bold; color:${isLatest ? 'var(--color-coral)' : '#333'};">
                                        ${rec.mbti} ${isLatest ? '<span style="font-size:0.7rem; background:var(--color-coral); color:white; padding:2px 6px; border-radius:10px; margin-left:5px;">í˜„ì¬</span>' : ''}
                                    </span>
                                </li>
                            `;
                        });
                        html += '</ul>';
                    }
                    listEl.innerHTML = html;
                } else {
                    listEl.innerHTML = '<p style="color:#999;">ì²« ê²€ì‚¬ì‹œë„¤ìš”! ë°ì´í„°ê°€ ìŒ“ì´ë©´ ì´ê³³ì— ì´ë ¥ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                }
            } catch (e) {
                console.error("History load failed", e);
                listEl.innerHTML = ''; // Hide on error
            }
        }

        async function loadFamilyResults(myMbti) {
            const listEl = document.getElementById('family-list');
            listEl.innerHTML = '';

            const familyScores = [];
            const familyNames = [];
            const familyColors = [];

            try {
                const snapshot = await window.db.collection('mbti_results_v2').get();
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-gray-400">ì•„ì§ ë‹¤ë¥¸ ê°€ì¡±ì˜ ê²°ê³¼ê°€ ì—†ë„¤ìš”.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const isMe = (window.auth.currentUser.uid === data.uid);

                    if (isMe) return;

                    const score = window.getCompatibility(myMbti, data.mbti);
                    const info = window.results[data.mbti];

                    familyNames.push(data.name);
                    familyScores.push(score);
                    familyColors.push(score >= 80 ? '#fca5a5' : (score >= 50 ? '#fbbf24' : '#93c5fd'));

                    const el = document.createElement('div');
                    el.className = 'family-result-card';
                    el.onclick = function () {
                        this.classList.toggle('expanded');
                    }
                    el.innerHTML = `
                        <div class="family-result-header" style="justify-content: flex-start; gap: 15px;">
                            <img src="${info.img}" style="width:50px; height:50px; border-radius:50%; background:#f0f0f0; object-fit: cover;">
                            <div>
                                <div style="font-weight:bold; font-size:1.1rem; color:#333;">
                                    ${data.name} <span style="color:var(--color-coral); margin-left:5px;">${data.mbti}</span>
                                </div>
                                <div style="color:#888; font-size:0.9rem;">
                                    ${info.name}
                                </div>
                            </div>
                            <div style="margin-left:auto; text-align:right;">
                                <div style="font-weight:bold; font-size:1.2rem; color:${score >= 80 ? '#ef4444' : (score >= 50 ? '#d97706' : '#666')}">
                                    ${score}ì  ${score >= 80 ? 'â¤ï¸' : ''}
                                </div>
                                <div style="font-size:0.8rem; color:#aaa;">í„°ì¹˜í•˜ì—¬ ìƒì„¸ë³´ê¸°</div>
                            </div>
                        </div>
                        <div class="family-detail">
                            <p style="line-height: 1.6; color: #555; margin-bottom: 20px;">${info.desc}</p>
                            
                            <h4 style="font-size:0.9rem; color:#666; margin-bottom:10px;">âœ¨ <strong>${data.name}</strong> (${data.mbti})ì˜ ìŠ¤íƒ€ì¼</h4>
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <div class="match-card" style="background-color: #fca5a5; padding: 10px; border-radius: 8px; flex: 1; text-align: center;">
                                    <span style="display:block; font-size:0.8rem; margin-bottom:5px; opacity:0.9;">â¤ï¸ ìµœê³ ì˜ ì§ê¿</span>
                                    <strong style="font-size:1.1rem;">${info.matches.best}</strong>
                                </div>
                                <div class="match-card" style="background-color: #93c5fd; padding: 10px; border-radius: 8px; flex: 1; text-align: center;">
                                    <span style="display:block; font-size:0.8rem; margin-bottom:5px; opacity:0.9;">âš¡ ë…¸ë ¥ í•„ìš”</span>
                                    <strong style="font-size:1.1rem;">${info.matches.worst}</strong>
                                </div>
                            </div>

                            <p style="margin-top:8px; color:#15803d; background:#f0fdf4; padding:8px; border-radius:4px;">ğŸ’¡ <strong>ê´€ê³„ íŒ</strong>: ${info.tips}</p>
                        </div>
                    `;
                    listEl.appendChild(el);
                });

                if (familyNames.length > 0) {
                    renderChart(familyNames, familyScores, familyColors);
                } else {
                    listEl.innerHTML = '<p class="text-center text-gray-400">ë¹„êµí•  ë‹¤ë¥¸ ê°€ì¡± ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (e) {
                console.error("Load family failed", e);
            }
        }

        function renderChart(labels, data, colors) {
            const ctx = document.getElementById('familyChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ê¶í•© ì ìˆ˜',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    </script>
</body>

</html>